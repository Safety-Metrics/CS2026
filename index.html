<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Safety Performance</title>

  <style>
    /* ==============================
      COOPER STEEL – 2026 DASHBOARD
      Executive / Premium Theme (CLEAN)
      Badge OFF
      + IOI TICKER (stock tape)
    ============================== */

    :root{
      --cream: #F2EFEB;
      --cloud: #CFCDCA;
      --cooper-red: #9F1C1F;
      --burgundy: #680C19;
      --onyx: #111112;
      --charcoal: #282828;
      --steel-gray: #5D5C5A;

      --radius-lg: 20px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --card-shadow: 0 18px 40px rgba(0,0,0,.45);
      --soft-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(159,28,31,.32), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(104,12,25,.38), transparent 65%),
        linear-gradient(180deg, #0c0c0d 0%, #141414 100%);
      color: var(--cream);
    }

    /* ---------- Top Logo Header (Badge OFF) ---------- */
    header.brand-header{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 26px 16px 6px;
    }

    /* Single source of truth for logo sizing */
    .brand-logo{
  height: clamp(110px, 10vw, 175px);
  width: auto;
  display:block;

  filter:
    drop-shadow(0 2px 3px rgba(255,255,255,.25))   /* edge clarity */
    drop-shadow(0 0 22px rgba(159,28,31,.55))      /* Cooper red glow */
    drop-shadow(0 0 44px rgba(159,28,31,.25))      /* feathered bleed */
    drop-shadow(0 16px 34px rgba(0,0,0,.45));

  animation: brandFloat 4.2s ease-in-out infinite;
}


    @keyframes brandFloat{
      0%,100% { transform: translateY(0) scale(1); }
      50%     { transform: translateY(-2px) scale(1.01); }
    }

    @media (prefers-reduced-motion: reduce){
      .brand-logo{ animation:none; }
    }

    /* ---------- Shell / Container ---------- */
    .shell{ width: 100%; }
    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 22px 80px;
    }

    /* ---------- Headings ---------- */
    h1{
      margin: 10px 0 6px;
      font-size: 36px;
      letter-spacing: -.02em;
      color: var(--cream);
    }

    .subhead{
      font-size: 14px;
      color: #d6d3cf;
      margin-bottom: 18px;
    }

    /* ---------- KPI Row ---------- */
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 14px;
      margin: 18px 0 14px;
    }

    .kpi{
      background: rgba(0,0,0,.45);
      border-radius: 14px;
      padding: 16px 16px 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      min-width: 0;
    }

    .kpi .val{
      font-size: 20px;
      font-weight: 700;
      color: var(--cream);
      letter-spacing: -.01em;
      line-height: 1.15;
    }

    .kpi .lab{
      margin-top: 6px;
      font-size: 12px;
      color: #bfbab5;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .kpi-row{ grid-template-columns: 1fr; }
    }

    /* ===========================
       IOI TICKER (Stock Tape)
    =========================== */

    .ioi-wrap{
      margin: 10px 0 26px;
    }

    .ioi-title{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 2px 10px;
    }

    .ioi-title h3{
      margin:0;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #d8d4cf;
      opacity: .95;
    }

    .ioi-title .ioi-sub{
      font-size: 12px;
      color: rgba(214,211,207,.75);
    }

    /* ---------- IOI Explainer (Panel/Modal) ---------- */
    .ioi-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ioi-info-btn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.06);
      color: #f1efec;
      font-weight: 800;
      letter-spacing: .02em;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      user-select: none;
      white-space: nowrap;
    }

    .ioi-info-btn:hover{ background: rgba(255,255,255,.09); }
    .ioi-info-btn:active{ transform: translateY(1px); }
    .ioi-info-btn .dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(159,28,31,.18);
      color: #ffd7d7;
      font-size: 12px;
      font-weight: 900;
      box-shadow: inset 0 0 0 1px rgba(159,28,31,.28);
    }

    .ioi-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }

    .ioi-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    /* Side panel (executive-friendly, mobile-safe) */
    .ioi-panel{
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(520px, 92vw);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(159,28,31,.18), transparent 55%),
        radial-gradient(700px 420px at 80% 20%, rgba(104,12,25,.18), transparent 60%),
        linear-gradient(180deg, rgba(14,14,15,1) 0%, rgba(10,10,11,1) 100%);
      color: var(--cream);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -18px 0 44px rgba(0,0,0,.55);
      z-index: 9999;
      transform: translateX(102%);
      transition: transform .22s ease;
      display:flex;
      flex-direction: column;
      overflow: hidden;
    }

    .ioi-panel.open{ transform: translateX(0); }

    .ioi-panel header{
      padding: 18px 18px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .ioi-panel .ph{
      min-width: 0;
    }

    .ioi-panel .ptitle{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0;
      color: #efece8;
    }

    .ioi-panel .psub{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(214,211,207,.78);
      line-height: 1.35;
    }

    .ioi-panel .close{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #f3f0ec;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing: .02em;
      min-height: 38px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .ioi-panel .close:hover{ background: rgba(255,255,255,.09); }
    .ioi-panel .close:active{ transform: translateY(1px); }

    .ioi-panel .body{
      padding: 14px 18px 18px;
      overflow:auto;
    }

    .ioi-note{
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      margin-bottom: 14px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.92);
    }

    .ioi-note strong{ color: #fff; }

    .ioi-metric{
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
      padding: 14px 14px 12px;
      margin-bottom: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }

    .ioi-metric h4{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #f1efec;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .ioi-tag{
      font-size: 11px;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(241,239,236,.92);
      letter-spacing: .02em;
      text-transform:none;
    }

    .ioi-tag.good{ color:#20c997; background: rgba(32,201,151,.12); border-color: rgba(32,201,151,.22); }
    .ioi-tag.bad { color:#ff5c5c; background: rgba(255,92,92,.12); border-color: rgba(255,92,92,.22); }
    .ioi-tag.neutral{ color:#c7c4bf; background: rgba(199,196,191,.10); border-color: rgba(199,196,191,.18); }

    .ioi-lines{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.90);
    }

    .ioi-lines .k{
      color: rgba(214,211,207,.82);
      font-weight: 800;
      letter-spacing: .02em;
    }

    .ioi-lines code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 10px;
      color: rgba(241,239,236,.92);
      white-space: nowrap;
    }

    .ioi-gates{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
      padding-top: 10px;
      display:grid;
      gap: 6px;
      font-size: 12px;
      color: rgba(241,239,236,.90);
    }

    .ioi-gates .gate{
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }

    .ioi-gates .b{
      font-weight: 900;
      letter-spacing: .02em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      min-width: 76px;
      text-align:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .ioi-gates .b.warn{ color:#ffd27b; background: rgba(246,193,70,.12); border-color: rgba(246,193,70,.24); }
    .ioi-gates .b.alert{ color:#ffb3b3; background: rgba(255,92,92,.14); border-color: rgba(255,92,92,.26); }

    @media (max-width: 520px){
      .ioi-title{
        align-items:flex-start;
      }
      .ioi-actions{
        width: 100%;
        justify-content: flex-start;
      }
    }

    .ticker{
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      background: rgba(0,0,0,.42);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      padding: 10px 0;
    }

    /* subtle top/bottom fade so ends aren’t harsh */
    .ticker:before,
    .ticker:after{
      content:"";
      position:absolute;
      top:0;
      width: 80px;
      height: 100%;
      z-index: 2;
      pointer-events:none;
    }

    .ticker:before{
      left:0;
      background: linear-gradient(90deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }
    .ticker:after{
      right:0;
      background: linear-gradient(270deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }

    .ticker-track{
      display:flex;
      gap: 18px;
      white-space: nowrap;
      will-change: transform;
      animation: tickerMove 26s linear infinite;
      padding-left: 16px;
    }

    /* Pause on hover (your requirement) */
    .ticker:hover .ticker-track{
      animation-play-state: paused;
    }

    @keyframes tickerMove{
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .tick{
      display:flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      font-size: 13px;
      color: #e9e6e2;
    }

    .tick .sym{
      font-weight: 900;
      letter-spacing: .02em;
      color: #f1efec;
      opacity: .95;
    }

    .tick .val{
      font-weight: 800;
      color: #fff;
    }

    .tick .chg{
      font-weight: 900;
      letter-spacing: .01em;
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }

    .chg.up{
      color: #20c997;
      background: rgba(32,201,151,.12);
    }
    .chg.down{
      color: #ff5c5c;
      background: rgba(255,92,92,.12);
    }
    .chg.flat{
      color: #c7c4bf;
      background: rgba(199,196,191,.10);
    }

    /* ---------- Section cards ---------- */
    .section{
      background: var(--cream);
      color: var(--onyx);
      border-radius: var(--radius-lg);
      padding: 26px;
      margin-bottom: 34px;
      box-shadow: var(--card-shadow);
    }

    .section h2{
      margin:0 0 6px;
      font-size: 20px;
      color: var(--onyx);
    }

    .section p{
      margin:0 0 18px;
      font-size: 13px;
      color: #444;
    }

    /* ---------- Form row / controls ---------- */
    .row{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .small{
      font-size: 12px;
      color: #555;
    }

    label.small{
      font-weight: 600;
      color: #333;
    }

    .input, input, select{
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      outline: none;
      min-height: 40px;
    }

    input.input{
      flex: 1 1 320px;
    }

    select{
      min-width: 160px;
    }

    button, .btn{
      font-family: inherit;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: #111;
      color: #fff;
      cursor: pointer;
      min-height: 40px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    button:hover, .btn:hover{ filter: brightness(1.05); }
    button:active, .btn:active{ transform: translateY(1px); }

    /* ---------- Panels ---------- */
    .panel{
      background: #f7f5f2;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--soft-shadow);
      border: 1px solid rgba(0,0,0,.06);
    }

    .panel-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title{
      font-weight: 800;
      letter-spacing: -.01em;
      color: #111;
    }

    .hint{
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }

    /* ---------- Key/Value grid ---------- */
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      margin-top: 12px;
      font-size: 13px;
    }

    .kv .k{ color: #444; }
    .kv .v{
      font-weight: 700;
      color: #111;
      text-align:right;
      white-space: nowrap;
    }

    /* ---------- Subcontractor Cards Grid ---------- */
    .grid-3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid-3{ grid-template-columns: 1fr; }
    }

    .card{
      background: #f5f3f0;
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--soft-shadow);
      transition: transform .25s ease, box-shadow .25s ease;
      border: 1px solid rgba(0,0,0,.05);
    }

    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 22px 50px rgba(0,0,0,.25);
    }

    .card h3{
      margin:0 0 6px;
      font-size: 16px;
      color: var(--onyx);
    }

    .meta{
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .card.clickable{ cursor: pointer; }

    .card.active{
      box-shadow:
        0 0 0 2px var(--burgundy),
        0 22px 50px rgba(0,0,0,.28);
    }

    /* ---------- Incidents ---------- */
    .inc-list{ margin-top: 10px; }

    .inc-row{
      display:grid;
      grid-template-columns: 1fr 1.2fr auto;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,.10);
      align-items:center;
    }
    @media (max-width: 760px){
      .inc-row{ grid-template-columns: 1fr; }
    }

    .link{
      color: var(--burgundy);
      font-weight: 700;
      text-decoration: none;
    }
    .link:hover{ text-decoration: underline; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      margin-left: 8px;
      vertical-align: middle;
    }
    .pill.high{ background:#f8d7da; color:#842029; }
    .pill.mod { background:#fff3cd; color:#856404; }
    .pill.low { background:#e7f5ec; color:#146c43; }

    /* ---------- Status ---------- */
    .status{
      margin-top: 14px;
      font-size: 12px;
      color: #6b6b6b;
    }
    .status.danger{
      color: #b42318;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <header class="brand-header">
    <img src="coopersteel-logo.png" alt="Cooper Steel" class="brand-logo">
  </header>

  <div class="shell">
    <div class="container">

      <h1>2026 Safety Performance</h1>
      <p class="subhead">Real-time safety metrics across all active projects and subcontractors.</p>

      <div class="kpi-row" id="kpis">
        <div class="kpi"><div class="val">—</div><div class="lab">Total Man-Hours</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">TRIR</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">LTIR</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">Total Recordables</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">Active Subcontractors</div></div>
      </div>

      <!-- ✅ IOI TICKER (Front and Center, under KPIs) -->
      <div class="ioi-wrap">
        <div class="ioi-title">
          <h3>Intelligent Operational Indicators</h3>
          <div class="ioi-actions">
            <div class="ioi-sub">Rolling 30-day signal • Hover to pause</div>
            <button class="ioi-info-btn" id="ioiExplainBtn" type="button" aria-haspopup="dialog" aria-controls="ioiPanel">
              <span class="dot">i</span> What's this?
            </button>
          </div>
        </div>
        <div class="ticker" id="ioiTicker">
          <div class="ticker-track" id="tickerTrack"></div>
        </div>
      </div>

      <!-- ✅ IOI EXPLAINER (Executive panel) -->
      <div class="ioi-backdrop" id="ioiBackdrop" aria-hidden="true"></div>
      <div class="ioi-panel" id="ioiPanel" role="dialog" aria-modal="true" aria-labelledby="ioiPanelTitle" aria-hidden="true">
        <header>
          <div class="ph">
            <div class="ptitle" id="ioiPanelTitle">Intelligent Operational Indicators</div>
            <div class="psub">
              Definitions for the ticker above. These are <strong>rolling 30‑day</strong> signals meant to highlight
              where attention should go <em>before</em> a serious event happens.
            </div>
          </div>
          <button class="close" id="ioiCloseBtn" type="button" aria-label="Close IOI explainer">Close</button>
        </header>

        <div class="body">
          <div class="ioi-note">
            <strong>How to read the ticker:</strong> The first number is the current 30‑day value. The second number (▲/▼) is the change versus the prior 30‑day window.
            <br><br>
            <strong>Important:</strong> “Up” is not always good. Some indicators rising is <strong class="bad">worse</strong> (risk increasing).
            This panel tells you which direction is good/bad for each indicator.
          </div>

          <div class="ioi-metric">
            <h4>EWIR (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> An exposure‑weighted incident rate for the last 30 days. Think: “How much stuff is happening, adjusted for hours worked.”</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> computed from <code>PUB_RECENT_INCIDENTS</code> + hours exposure (from <code>PUB_KPI</code>/<code>PUB_SUBS</code>).</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D EWIR. Delta = how much that EWIR moved compared to the previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>EWIR increases for 2 consecutive refresh cycles (trend), even if the number is “small.”</div>
              <div class="gate"><span class="b alert">Escalate</span>Large positive delta (sharp jump), or EWIR stays elevated > 30 days.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>RISK CONC (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> Risk concentration—how clustered incidents are. Higher = problems are piling up in fewer places (one sub/site dragging the system).</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> derived from incident distribution in <code>PUB_RECENT_INCIDENTS</code> (by sub/project) and exposure.</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D concentration. Delta = movement vs previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Positive delta + the same sub/project repeatedly appearing in incidents.</div>
              <div class="gate"><span class="b alert">Escalate</span>Concentration rising while total volume is flat (means the risk is “sticking” to one area).</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>MOMENTUM (30D) <span class="ioi-tag neutral">Context</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> A direction‑of‑travel signal. It summarizes whether the overall 30‑day risk picture is improving or worsening.</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> (a blended signal from incidents, severity mix, and exposure patterns).</div>
              <div><span class="k">Value vs Delta:</span> Value = current momentum score. Delta = how the momentum shifted versus the prior 30D.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Momentum rising at the same time EWIR or Risk Concentration rises.</div>
              <div class="gate"><span class="b alert">Escalate</span>Momentum shows a sharp increase (big delta) even if recordables haven’t moved yet.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>TOP RISK SUB (≥500H) <span class="ioi-tag bad">Flag</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> The subcontractor with the highest weighted risk signal—only among subs with meaningful exposure (≥500 hours).</div>
              <div><span class="k">Data origin:</span> Name is surfaced in <code>PUB_IOI</code>, typically based on risk weighting from <code>PUB_SUBS</code> + <code>PUB_RECENT_INCIDENTS</code>.</div>
              <div><span class="k">Value vs Delta:</span> Value = the subcontractor name. No delta (it’s a label, not a rate).</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>If the same sub repeats week over week: do a focused field verification + coaching.</div>
              <div class="gate"><span class="b alert">Escalate</span>If that sub also shows rising EWIR / concentration: immediate plan, accountability, and increased oversight.</div>
            </div>
          </div>

          <div class="ioi-note">
            <strong>Quick “good vs bad” cheat sheet:</strong><br>
            • <strong class="bad">EWIR up</strong> = risk rising (bad).<br>
            • <strong class="bad">Risk Concentration up</strong> = risk clustering (bad).<br>
            • <strong>MOMENTUM</strong> = interpret with the other signals (context).<br>
            • <strong>Top Risk Sub</strong> = where to look first.
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Subcontractor Performance</h2>
        <p>Top subcontractors by hours are shown below. Use the lookup to view any subcontractor.</p>

        <div class="row">
          <label class="small" for="subPick">Subcontractor</label>
          <input class="input" id="subPick" list="subList" placeholder="Type a subcontractor name…" autocomplete="off" />
          <datalist id="subList"></datalist>
        </div>

        <div class="panel" id="subDetail" style="margin-top:12px;">
          <div class="title">Select a subcontractor</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        </div>

        <div style="height:16px"></div>
        <div class="grid-3" id="subCards"></div>
        <div class="status" id="subHint"></div>

        <div class="panel" id="subIncPanel" style="display:none; margin-top:14px;">
          <div class="panel-head">
            <div>
              <div class="title" id="subIncTitle">Incidents —</div>
              <div class="hint" id="subIncHint">Showing incidents for selected subcontractor.</div>
            </div>
            <button class="btn" id="subIncClose" type="button">Close</button>
          </div>
          <div id="subIncList"></div>
        </div>
      </div>

      <!-- ✅ IOI EXPLAINER (Executive panel) -->
      <div class="ioi-backdrop" id="ioiBackdrop" aria-hidden="true"></div>
      <div class="ioi-panel" id="ioiPanel" role="dialog" aria-modal="true" aria-labelledby="ioiPanelTitle" aria-hidden="true">
        <header>
          <div class="ph">
            <div class="ptitle" id="ioiPanelTitle">Intelligent Operational Indicators</div>
            <div class="psub">
              Simple, executive-friendly definitions for the ticker above. These are <strong>rolling 30‑day</strong> signals meant to highlight
              where attention should go <em>before</em> a serious event happens.
            </div>
          </div>
          <button class="close" id="ioiCloseBtn" type="button" aria-label="Close IOI explainer">Close</button>
        </header>

        <div class="body">
          <div class="ioi-note">
            <strong>How to read the ticker:</strong> The first number is the current 30‑day value. The second number (▲/▼) is the change versus the prior 30‑day window.
            <br><br>
            <strong>Important:</strong> “Up” is not always good. Some indicators rising is <strong class="bad">worse</strong> (risk increasing).
            This panel tells you which direction is good/bad for each indicator.
          </div>

          <div class="ioi-metric">
            <h4>EWIR (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> An exposure‑weighted incident rate for the last 30 days. Think: “How much stuff is happening, adjusted for hours worked.”</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> computed from <code>PUB_RECENT_INCIDENTS</code> + hours exposure (from <code>PUB_KPI</code>/<code>PUB_SUBS</code>).</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D EWIR. Delta = how much that EWIR moved compared to the previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>EWIR increases for 2 consecutive refresh cycles (trend), even if the number is “small.”</div>
              <div class="gate"><span class="b alert">Escalate</span>Large positive delta (sharp jump), or EWIR stays elevated > 30 days.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>RISK CONC (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> Risk concentration—how clustered incidents are. Higher = problems are piling up in fewer places (one sub/site dragging the system).</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> derived from incident distribution in <code>PUB_RECENT_INCIDENTS</code> (by sub/project) and exposure.</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D concentration. Delta = movement vs previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Positive delta + the same sub/project repeatedly appearing in incidents.</div>
              <div class="gate"><span class="b alert">Escalate</span>Concentration rising while total volume is flat (means the risk is “sticking” to one area).</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>MOMENTUM (30D) <span class="ioi-tag neutral">Context</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> A direction‑of‑travel signal. It summarizes whether the overall 30‑day risk picture is improving or worsening.</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> (a blended signal from incidents, severity mix, and exposure patterns).</div>
              <div><span class="k">Value vs Delta:</span> Value = current momentum score. Delta = how the momentum shifted versus the prior 30D.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Momentum rising at the same time EWIR or Risk Concentration rises.</div>
              <div class="gate"><span class="b alert">Escalate</span>Momentum shows a sharp increase (big delta) even if recordables haven’t moved yet.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>TOP RISK SUB (≥500H) <span class="ioi-tag bad">Flag</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> The subcontractor with the highest weighted risk signal—only among subs with meaningful exposure (≥500 hours).</div>
              <div><span class="k">Data origin:</span> Name is surfaced in <code>PUB_IOI</code>, typically based on risk weighting from <code>PUB_SUBS</code> + <code>PUB_RECENT_INCIDENTS</code>.</div>
              <div><span class="k">Value vs Delta:</span> Value = the subcontractor name. No delta (it’s a label, not a rate).</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>If the same sub repeats week over week: do a focused field verification + coaching.</div>
              <div class="gate"><span class="b alert">Escalate</span>If that sub also shows rising EWIR / concentration: immediate plan, accountability, and increased oversight.</div>
            </div>
          </div>

          <div class="ioi-note">
            <strong>Quick “good vs bad” cheat sheet:</strong><br>
            • <strong class="bad">EWIR up</strong> = risk rising (bad).<br>
            • <strong class="bad">Risk Concentration up</strong> = risk clustering (bad).<br>
            • <strong>MOMENTUM</strong> = interpret with the other signals (context).<br>
            • <strong>Top Risk Sub</strong> = where to look first.
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Incidents</h2>
        <p>Latest incidents shown. Search by subcontractor, project, or incident ID.</p>

        <div class="row">
          <input class="input" id="q" placeholder="Search incidents (sub, project, ID)" autocomplete="off" />
          <select id="sev">
            <option value="">Severity: All</option>
            <option value="High">High</option>
            <option value="Moderate">Moderate</option>
            <option value="Low">Low</option>
          </select>
          <button id="clear">Clear</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="small" for="incPick">Incident</label>
          <input class="input" id="incPick" list="incList" placeholder="Type an Incident ID…" autocomplete="off" />
          <datalist id="incList"></datalist>
        </div>

        <div class="panel" id="incDetail" style="margin-top:12px;">
          <div class="title">Select an incident</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        </div>

        <div class="inc-list" id="incidentList"></div>
        <div class="status" id="incHint"></div>

        <div style="margin-top:12px" class="small">
          Click “View report” to see the incident report details.
        </div>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    /*** CONFIG: your published CSV URLs ***/
    const KPI_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=152373673&single=true&output=csv";
    const SUBS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=466735545&single=true&output=csv";
    const INCIDENTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=1844704592&single=true&output=csv";

    /* ✅ PASTE YOUR PUB_IOI PUBLISHED CSV LINK HERE */
    const IOI_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=35539167&single=true&output=csv";

    /*** helpers ***/
    const bust = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

    function setStatus(msg, isErr=false){
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.className = "status" + (isErr ? " danger" : "");
    }

    function toNumber(x){
      if (x === null || x === undefined) return 0;
      const n = parseFloat(String(x).replace(/,/g,"").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(x){
      return (x === null || x === undefined) ? "" : String(x);
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const next = text[i+1];

        if (c === '"' ){
          if (inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && c === "," ){
          row.push(cur); cur = ""; continue;
        }
        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r"  && next === "\n")  i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }
        cur += c;
      }
      row.push(cur);
      rows.push(row);
      return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
    }

    async function fetchTable(url){
      const res = await fetch(bust(url), { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status);
      const txt = await res.text();
      const grid = parseCSV(txt);

      if (!grid.length) return [];
      const headers = grid[0].map(h => String(h).trim());
      const out = [];

      for (let i=1; i<grid.length; i++){
        const obj = {};
        for (let j=0; j<headers.length; j++){
          obj[headers[j] || ("col"+j)] = (grid[i][j] ?? "").trim();
        }
        out.push(obj);
      }
      return out;
    }

    /*** KPI ***/
    function renderKPIs(kpis){
      const map = {};
      kpis.forEach(r => { map[r.Metric] = r.Value; });

      const kpiEls = document.getElementById("kpis").querySelectorAll(".kpi .val");
      const totalHours = safeText(map["Total Man-Hours"] ?? "—");
      const trir = safeText(map["TRIR"] ?? "—");
      const ltir = safeText(map["LTIR"] ?? "—");
      const rec = safeText(map["Total Recordables"] ?? "—");
      const active = safeText(map["Active Subcontractors"] ?? "—");

      kpiEls[0].textContent = totalHours;
      kpiEls[1].textContent = trir;
      kpiEls[2].textContent = ltir;
      kpiEls[3].textContent = rec;
      kpiEls[4].textContent = active;
    }

    /*** IOI TICKER ***/
    function fmt(n, d=2){
      const num = parseFloat(n);
      if (!Number.isFinite(num)) return safeText(n) || "—";
      return num.toFixed(d);
    }

    function buildTick(label, value, delta){
      const d = parseFloat(delta);
      let cls = "flat", arrow = "•", sign = "";
      if (Number.isFinite(d)){
        if (d > 0){ cls = "up"; arrow = "▲"; sign = "+"; }
        else if (d < 0){ cls = "down"; arrow = "▼"; sign = ""; }
      } else {
        delta = "";
      }

      const deltaTxt = (delta === "" || delta === null || delta === undefined)
        ? ""
        : `${arrow} ${sign}${fmt(d,2)}`;

      return `
        <div class="tick">
          <span class="sym">${label}</span>
          <span class="val">${value}</span>
          <span class="chg ${cls}">${deltaTxt || "• —"}</span>
        </div>
      `;
    }

    function renderIOITicker(ioiRow){
      const track = document.getElementById("tickerTrack");

      if (!ioiRow){
        track.innerHTML = `<div class="tick"><span class="sym">IOI</span><span class="val">No data</span><span class="chg flat">• —</span></div>`;
        return;
      }

      // Expected PUB_IOI headers:
      // EWIR_30, EWIR_DELTA, RISK_CONC_30, RISK_CONC_DELTA, MOMENTUM_30, MOMENTUM_DELTA, TOP_RISK_SUB_30
      const ewir = safeText(ioiRow.EWIR_30 || "");
      const ewirD = safeText(ioiRow.EWIR_DELTA || "");

      const rc = safeText(ioiRow.RISK_CONC_30 || "");
      const rcD = safeText(ioiRow.RISK_CONC_DELTA || "");

      const mom = safeText(ioiRow.MOMENTUM_30 || "");
      const momD = safeText(ioiRow.MOMENTUM_DELTA || "");

      const top = safeText(ioiRow.TOP_RISK_SUB_30 || "");

      const items = [
        buildTick("EWIR (30D)", fmt(ewir,2), ewirD),
        buildTick("RISK CONC (30D)", fmt(rc,4), rcD),
        buildTick("MOMENTUM (30D)", fmt(mom,2), momD),
        `
        <div class="tick">
          <span class="sym">TOP RISK SUB (≥500H)</span>
          <span class="val">${top || "—"}</span>
          <span class="chg flat">•</span>
        </div>
        `
      ].join("");

      // Duplicate for seamless loop (animation goes to -50%)
      track.innerHTML = items + items;

      // Optional: if fewer items, speed up a bit
      // (we can tune later if you want it faster/slower)
    }

    async function loadIOI(){
      try{
        // If you haven't pasted IOI_CSV yet, don't explode the page.
        if (!IOI_CSV || IOI_CSV.includes("PASTE_YOUR_PUB_IOI_CSV_URL_HERE")){
          renderIOITicker(null);
          return;
        }
        const rows = await fetchTable(IOI_CSV);
        // PUB_IOI is a single row output (Row 2)
        renderIOITicker(rows[0] || null);
      } catch (e){
        console.error(e);
        renderIOITicker(null);
      }
    }


    /*** IOI EXPLAINER PANEL ***/
    function openIOIPanel(){
      const panel = document.getElementById("ioiPanel");
      const back = document.getElementById("ioiBackdrop");
      if (!panel || !back) return;

      panel.classList.add("open");
      back.classList.add("open");
      panel.setAttribute("aria-hidden", "false");
      back.setAttribute("aria-hidden", "false");

      // lock body scroll while panel open (mobile especially)
      document.body.style.overflow = "hidden";

      // focus management (accessibility + keyboard)
      const close = document.getElementById("ioiCloseBtn");
      if (close) close.focus();
    }

    function closeIOIPanel(){
      const panel = document.getElementById("ioiPanel");
      const back = document.getElementById("ioiBackdrop");
      if (!panel || !back) return;

      panel.classList.remove("open");
      back.classList.remove("open");
      panel.setAttribute("aria-hidden", "true");
      back.setAttribute("aria-hidden", "true");

      document.body.style.overflow = "";

      const btn = document.getElementById("ioiExplainBtn");
      if (btn) btn.focus();
    }

    function toggleIOIPanel(){
      const panel = document.getElementById("ioiPanel");
      if (!panel) return;
      if (panel.classList.contains("open")) closeIOIPanel();
      else openIOIPanel();
    }


    /*** SUBS ***/
    let SUBS_ALL = [];

    function normalizeSubsRows(rows){
      return rows.map(r => {
        const sub = r.Subcontractor || r.subcontractor || r.Sub || r.SUB || r.Name || r.name || "";
        const hours = toNumber(r.TotalHours ?? r.Hours ?? r.hours ?? 0);
        const incidents = toNumber(r.TotalIncidents ?? r.Incidents ?? r.incidents ?? 0);
        const recordables = toNumber(r.Recordables ?? r.recordables ?? 0);
        const lost = toNumber(r.LostTime ?? r.Lost ?? r.losttime ?? 0);
        const trir = safeText(r.TRIR ?? r.trir ?? "");
        const ltir = safeText(r.LTIR ?? r.ltir ?? "");
        return {
          sub: String(sub).trim(),
          hours,
          incidents,
          recordables,
          lost,
          trir: (trir === "" ? "" : String(trir)),
          ltir: (ltir === "" ? "" : String(ltir))
        };
      }).filter(x => x.sub && x.sub.toLowerCase() !== "subcontractor");
    }

    function renderSubDetail(item){
      const box = document.getElementById("subDetail");
      if (!item){
        box.innerHTML = `
          <div class="title">Select a subcontractor</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="title">${item.sub}</div>
        <div class="hint">YTD exposure & rates</div>
        <div class="kv">
          <div class="k">Hours</div><div class="v">${item.hours.toLocaleString()}</div>
          <div class="k">Incidents</div><div class="v">${item.incidents}</div>
          <div class="k">Recordables</div><div class="v">${item.recordables}</div>
          <div class="k">Lost Time</div><div class="v">${item.lost}</div>
          <div class="k">TRIR</div><div class="v">${item.trir || "0"}</div>
          <div class="k">LTIR</div><div class="v">${item.ltir || "0"}</div>
        </div>
      `;
    }

    function renderSubs(rows){
      SUBS_ALL = normalizeSubsRows(rows);

      const dl = document.getElementById("subList");
      dl.innerHTML = [...SUBS_ALL]
        .sort((a,b)=> a.sub.localeCompare(b.sub))
        .map(r => `<option value="${r.sub}"></option>`)
        .join("");

      const top = [...SUBS_ALL].sort((a,b)=> b.hours - a.hours).slice(0, 9);
      const wrap = document.getElementById("subCards");
      wrap.innerHTML = top.map(r => `
        <div class="card clickable" data-sub="${r.sub}">
          <h3>${r.sub}</h3>
          <div class="meta">YTD exposure & rates</div>
          <div class="kv">
            <div class="k">Hours</div><div class="v">${r.hours.toLocaleString()}</div>
            <div class="k">Incidents</div><div class="v">${r.incidents}</div>
            <div class="k">Recordables</div><div class="v">${r.recordables}</div>
            <div class="k">TRIR</div><div class="v">${r.trir || "0"}</div>
            <div class="k">LTIR</div><div class="v">${r.ltir || "0"}</div>
          </div>
        </div>
      `).join("");

      [...wrap.querySelectorAll(".card.clickable")].forEach(card=>{
        card.addEventListener("click", ()=>{
          const sub = card.dataset.sub || "";
          setActiveSubCard(sub);
          openSubIncidentsPanel(sub);
        });
      });

      document.getElementById("subHint").textContent =
        `Showing top ${top.length} by hours. Use lookup to view any of ${SUBS_ALL.length} subcontractors.`;

      const pick = document.getElementById("subPick");
      if (!pick.dataset.wired){
        pick.dataset.wired = "1";
        const apply = () => {
          const v = (pick.value || "").trim().toLowerCase();
          const found = SUBS_ALL.find(x => x.sub.toLowerCase() === v);
          renderSubDetail(found || null);
        };
        pick.addEventListener("change", apply);
        pick.addEventListener("blur", apply);
        pick.addEventListener("keydown", (e)=>{ if (e.key === "Enter") apply(); });
      }
    }

    /*** INCIDENTS ***/
    let INC_ALL = [];
    let ACTIVE_SUB = "";

    function setActiveSubCard(sub){
      ACTIVE_SUB = sub || "";
      document.querySelectorAll("#subCards .card.clickable").forEach(el=>{
        if ((el.dataset.sub || "") === ACTIVE_SUB) el.classList.add("active");
        else el.classList.remove("active");
      });
    }

    function pillForSeverity(sev){
      const s = (sev || "").toLowerCase();
      if (s === "high") return `<span class="pill high">High</span>`;
      if (s === "moderate") return `<span class="pill mod">Moderate</span>`;
      if (s === "low") return `<span class="pill low">Low</span>`;
      return "";
    }

    function openSubIncidentsPanel(sub){
      const panel = document.getElementById("subIncPanel");
      const title = document.getElementById("subIncTitle");
      const hint = document.getElementById("subIncHint");
      const list = document.getElementById("subIncList");

      const s = (sub || "").trim();
      title.textContent = s ? `Incidents — ${s}` : "Incidents —";
      panel.style.display = "block";

      const rows = [...INC_ALL]
        .filter(r => String(r.Subcontractor || "").trim().toLowerCase() === s.toLowerCase())
        .sort((a,b)=> String(b.Date||"").localeCompare(String(a.Date||"")));

      hint.textContent = rows.length ? `${rows.length} incident(s) found.` : "No incidents found for this subcontractor.";

      if (!rows.length){
        list.innerHTML = `<div class="small">No incidents match.</div>`;
        return;
      }

      const cap = 25;
      const shown = rows.slice(0, cap);

      list.innerHTML = shown.map(r => `
        <div class="inc-row">
          <div>
            <strong>${safeText(r.Date) || "—"}</strong>
            <div class="meta">${safeText(r.IncidentID) || "—"}</div>
          </div>
          <div>
            <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
            <div class="meta">${safeText(r.Project) || ""}</div>
          </div>
          <div style="text-align:right;">
            ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
          </div>
        </div>
      `).join("");

      if (rows.length > cap){
        list.innerHTML += `<div class="small" style="padding-top:10px;">Showing first ${cap}. Refine using the Incidents search below if needed.</div>`;
      }
    }

    function normalizeIncidentRows(rows){
      return rows.map(r => ({
        Date: r.Date || r.date || "",
        IncidentID: r.IncidentID || r.IncidentId || r.ID || r.Id || "",
        Subcontractor: r.Subcontractor || r.subcontractor || r.Sub || "",
        Project: r.Project || r.project || "",
        Severity: r.Severity || r.severity || "",
        ReportLink: r.ReportLink || r.reportlink || r.Link || ""
      })).filter(x => x.IncidentID && String(x.IncidentID).trim().toLowerCase() !== "incidentid");
    }

    function renderIncidentDetail(item){
      const box = document.getElementById("incDetail");
      if(!item){
        box.innerHTML = `
          <div class="title">Select an incident</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="title">${safeText(item.IncidentID) || "—"}</div>
        <div class="hint">${safeText(item.Date) || ""} • ${safeText(item.Severity) || "—"} • ${safeText(item.Subcontractor) || "—"}</div>
        <div class="kv">
          <div class="k">Project</div><div class="v">${safeText(item.Project) || "—"}</div>
          <div class="k">Subcontractor</div><div class="v">${safeText(item.Subcontractor) || "—"}</div>
          <div class="k">Severity</div><div class="v">${safeText(item.Severity) || "—"}</div>
          <div class="k">Date</div><div class="v">${safeText(item.Date) || "—"}</div>
        </div>
        <div style="margin-top:12px;">
          ${item.ReportLink
            ? `<a class="link" href="${item.ReportLink}" target="_blank" rel="noopener">View report</a>`
            : `<span class="small">No report link</span>`}
        </div>
      `;
    }

    function renderIncidentsLookup(rows){
      INC_ALL = normalizeIncidentRows(rows);

      const dl = document.getElementById("incList");
      dl.innerHTML = [...INC_ALL]
        .sort((a,b)=> String(a.IncidentID).localeCompare(String(b.IncidentID)))
        .map(r => `<option value="${safeText(r.IncidentID)}"></option>`)
        .join("");

      const pick = document.getElementById("incPick");
      if(!pick.dataset.wired){
        pick.dataset.wired = "1";
        const apply = () => {
          const v = (pick.value || "").trim().toLowerCase();
          const found = INC_ALL.find(x => String(x.IncidentID || "").trim().toLowerCase() === v);
          renderIncidentDetail(found || null);
        };
        pick.addEventListener("change", apply);
        pick.addEventListener("blur", apply);
        pick.addEventListener("keydown", (e)=>{ if(e.key==="Enter") apply(); });
      }
    }

    function renderIncidentsTable(allIncidents){
      const q = document.getElementById("q").value.trim().toLowerCase();
      const sev = document.getElementById("sev").value;

      let rows = normalizeIncidentRows(allIncidents);

      if (sev) rows = rows.filter(r => (r.Severity || "") === sev);

      if (q){
        rows = rows.filter(r => (
          String(r.IncidentID || "").toLowerCase().includes(q) ||
          String(r.Subcontractor || "").toLowerCase().includes(q) ||
          String(r.Project || "").toLowerCase().includes(q)
        ));
      }

      rows.sort((a,b)=>{
        const da = Date.parse(a.Date) || 0;
        const db = Date.parse(b.Date) || 0;
        return db - da;
      });

      const cap = (q || sev) ? 10 : 5;
      const shown = rows.slice(0, cap);

      document.getElementById("incHint").textContent =
        (q || sev)
          ? `Showing top ${Math.min(cap, rows.length)} matches (capped).`
          : "Showing latest 5 incidents.";

      const list = document.getElementById("incidentList");
      if (!shown.length){
        list.innerHTML = `<div class="small" style="padding:12px 0;">No incidents match your filters.</div>`;
        return;
      }

      list.innerHTML = shown.map(r => `
        <div class="inc-row">
          <div>
            <strong>${safeText(r.Date) || "—"}</strong>
            <div class="meta">${safeText(r.IncidentID) || "—"}</div>
          </div>
          <div>
            <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
            <div class="meta">${safeText(r.Project) || ""}</div>
          </div>
          <div style="text-align:right;">
            ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
          </div>
        </div>
      `).join("");
    }

    /*** init ***/
    (async function init(){
      try {
        setStatus("Loading data…");

        const [kpis, subs, inc] = await Promise.all([
          fetchTable(KPI_CSV),
          fetchTable(SUBS_CSV),
          fetchTable(INCIDENTS_CSV)
        ]);

        renderKPIs(kpis);
        renderSubs(subs);

        // Incidents
        renderIncidentsTable(inc);
        renderIncidentsLookup(inc);

        // Auto-select latest incident into detail panel
        const latest = normalizeIncidentRows(inc).sort((a,b)=>{
          const da = Date.parse(a.Date) || 0;
          const db = Date.parse(b.Date) || 0;
          return db - da;
        })[0];
        if (latest) renderIncidentDetail(latest);

        // Sub incident panel close
        const subClose = document.getElementById("subIncClose");
        subClose.addEventListener("click", ()=>{
          document.getElementById("subIncPanel").style.display = "none";
          setActiveSubCard("");
        });

        document.getElementById("q").addEventListener("input", ()=>renderIncidentsTable(inc));
        document.getElementById("sev").addEventListener("change", ()=>renderIncidentsTable(inc));
        document.getElementById("clear").addEventListener("click", (e)=>{
          e.preventDefault();
          document.getElementById("q").value = "";
          document.getElementById("sev").value = "";
          renderIncidentsTable(inc);
        });

        // ✅ IOI ticker load (separate call so it doesn't block main UI)
        loadIOI();

        // ✅ IOI explainer wiring (button + backdrop + ESC)
        const ioiBtn = document.getElementById("ioiExplainBtn");
        const ioiClose = document.getElementById("ioiCloseBtn");
        const ioiBack = document.getElementById("ioiBackdrop");

        if (ioiBtn && !ioiBtn.dataset.wired){
          ioiBtn.dataset.wired = "1";
          ioiBtn.addEventListener("click", toggleIOIPanel);
        }
        if (ioiClose && !ioiClose.dataset.wired){
          ioiClose.dataset.wired = "1";
          ioiClose.addEventListener("click", closeIOIPanel);
        }
        if (ioiBack && !ioiBack.dataset.wired){
          ioiBack.dataset.wired = "1";
          ioiBack.addEventListener("click", closeIOIPanel);
        }

        document.addEventListener("keydown", (e)=>{
          if (e.key === "Escape"){
            const panel = document.getElementById("ioiPanel");
            if (panel && panel.classList.contains("open")) closeIOIPanel();
          }
        });

        setStatus("");
      } catch (err){
        console.error(err);
        setStatus("Data fetch failed. Check CSV publish links, then refresh.", true);
        document.getElementById("subHint").textContent = "Could not load subcontractor data. Verify your published SUBS CSV.";
        document.getElementById("incHint").textContent = "Could not load incidents. Verify your published INCIDENTS CSV.";
      }
    })();
  </script>
</body>
</html>


