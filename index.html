<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Safety Performance</title>
  <link rel="icon" href="data:;base64,=">

  <style>
    /* ==============================
      COOPER STEEL – 2026 DASHBOARD
      Executive / Premium Theme (CLEAN)
      Badge OFF
      + IOI TICKER (stock tape)
    ============================== */

    :root{
      --cream: #F2EFEB;
      --cloud: #CFCDCA;
      --cooper-red: #9F1C1F;
      --burgundy: #680C19;
      --onyx: #111112;
      --charcoal: #282828;
      --steel-gray: #5D5C5A;

      --radius-lg: 20px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --card-shadow: 0 18px 40px rgba(0,0,0,.45);
      --soft-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(159,28,31,.32), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(104,12,25,.38), transparent 65%),
        linear-gradient(180deg, #0c0c0d 0%, #141414 100%);
      color: var(--cream);
    }

    /* ---------- Top Logo Header (Badge OFF) ---------- */
    header.brand-header{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 26px 16px 6px;
    }

    /* Single source of truth for logo sizing */
    .brand-logo{
  height: clamp(110px, 10vw, 175px);
  width: auto;
  display:block;

  filter:
    drop-shadow(0 2px 3px rgba(255,255,255,.25))   /* edge clarity */
    drop-shadow(0 0 22px rgba(159,28,31,.55))      /* Cooper red glow */
    drop-shadow(0 0 44px rgba(159,28,31,.25))      /* feathered bleed */
    drop-shadow(0 16px 34px rgba(0,0,0,.45));

  animation: brandFloat 4.2s ease-in-out infinite;
}


    @keyframes brandFloat{
      0%,100% { transform: translateY(0) scale(1); }
      50%     { transform: translateY(-2px) scale(1.01); }
    }

    @media (prefers-reduced-motion: reduce){
      .brand-logo{ animation:none; }
    }

    /* ---------- Shell / Container ---------- */
    .shell{ width: 100%; }
    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 22px 80px;
    }

    /* ---------- Headings ---------- */
    h1{
      margin: 10px 0 6px;
      font-size: 36px;
      letter-spacing: -.02em;
      color: var(--cream);
    }

    .subhead{
      font-size: 14px;
      color: #d6d3cf;
      margin-bottom: 18px;
    }

    /* ---------- KPI Row ---------- */
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 14px;
      margin: 18px 0 14px;
    }

    .kpi{
      background: rgba(0,0,0,.45);
      border-radius: 14px;
      padding: 16px 16px 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      min-width: 0;
    }

    .kpi .val{
      font-size: 20px;
      font-weight: 700;
      color: var(--cream);
      letter-spacing: -.01em;
      line-height: 1.15;
    }

    .kpi .lab{
      margin-top: 6px;
      font-size: 12px;
      color: #bfbab5;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .kpi-row{ grid-template-columns: 1fr; }
    }

    /* ===========================
       IOI TICKER (Stock Tape)
    =========================== */

    .ioi-wrap{
      margin: 10px 0 26px;
    }

    .ioi-title{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 2px 10px;
    }

    .ioi-title h3{
      margin:0;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #d8d4cf;
      opacity: .95;
    }

    .ioi-title .ioi-sub{
      font-size: 12px;
      color: rgba(214,211,207,.75);
    }

    /* ---------- IOI Explainer (Panel/Modal) ---------- */
    .ioi-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ioi-info-btn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.06);
      color: #f1efec;
      font-weight: 800;
      letter-spacing: .02em;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      user-select: none;
      white-space: nowrap;
    }

    .ioi-info-btn:hover{ background: rgba(255,255,255,.09); }
    .ioi-info-btn:active{ transform: translateY(1px); }
    .ioi-info-btn .dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(159,28,31,.18);
      color: #ffd7d7;
      font-size: 12px;
      font-weight: 900;
      box-shadow: inset 0 0 0 1px rgba(159,28,31,.28);
    }

    .ioi-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }

    .ioi-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    /* Side panel (executive-friendly, mobile-safe) */
    .ioi-panel{
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(520px, 92vw);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(159,28,31,.18), transparent 55%),
        radial-gradient(700px 420px at 80% 20%, rgba(104,12,25,.18), transparent 60%),
        linear-gradient(180deg, rgba(14,14,15,1) 0%, rgba(10,10,11,1) 100%);
      color: var(--cream);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -18px 0 44px rgba(0,0,0,.55);
      z-index: 9999;
      transform: translateX(102%);
      transition: transform .22s ease;
      display:flex;
      flex-direction: column;
      overflow: hidden;
    }

    .ioi-panel.open{ transform: translateX(0); }

    .ioi-panel header{
      padding: 18px 18px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .ioi-panel .ph{
      min-width: 0;
    }

    .ioi-panel .ptitle{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0;
      color: #efece8;
    }

    .ioi-panel .psub{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(214,211,207,.78);
      line-height: 1.35;
    }

    .ioi-panel .close{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #f3f0ec;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing: .02em;
      min-height: 38px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .ioi-panel .close:hover{ background: rgba(255,255,255,.09); }
    .ioi-panel .close:active{ transform: translateY(1px); }

    .ioi-panel .body{
      padding: 14px 18px 18px;
      overflow:auto;
    }

    .ioi-note{
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      margin-bottom: 14px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.92);
    }

    .ioi-note strong{ color: #fff; }

    .ioi-metric{
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
      padding: 14px 14px 12px;
      margin-bottom: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }

    .ioi-metric h4{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #f1efec;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .ioi-tag{
      font-size: 11px;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(241,239,236,.92);
      letter-spacing: .02em;
      text-transform:none;
    }

    .ioi-tag.good{ color:#20c997; background: rgba(32,201,151,.12); border-color: rgba(32,201,151,.22); }
    .ioi-tag.bad { color:#ff5c5c; background: rgba(255,92,92,.12); border-color: rgba(255,92,92,.22); }
    .ioi-tag.neutral{ color:#c7c4bf; background: rgba(199,196,191,.10); border-color: rgba(199,196,191,.18); }

    .ioi-lines{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.90);
    }

    .ioi-lines .k{
      color: rgba(214,211,207,.82);
      font-weight: 800;
      letter-spacing: .02em;
    }

    .ioi-lines code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 10px;
      color: rgba(241,239,236,.92);
      white-space: nowrap;
    }

    .ioi-gates{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
      padding-top: 10px;
      display:grid;
      gap: 6px;
      font-size: 12px;
      color: rgba(241,239,236,.90);
    }

    .ioi-gates .gate{
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }

    .ioi-gates .b{
      font-weight: 900;
      letter-spacing: .02em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      min-width: 76px;
      text-align:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .ioi-gates .b.warn{ color:#ffd27b; background: rgba(246,193,70,.12); border-color: rgba(246,193,70,.24); }
    .ioi-gates .b.alert{ color:#ffb3b3; background: rgba(255,92,92,.14); border-color: rgba(255,92,92,.26); }

    @media (max-width: 520px){
      .ioi-title{
        align-items:flex-start;
      }
      .ioi-actions{
        width: 100%;
        justify-content: flex-start;
      }
    }

    .ticker{
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      background: rgba(0,0,0,.42);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      padding: 10px 0;
    }

    /* subtle top/bottom fade so ends aren’t harsh */
    .ticker:before,
    .ticker:after{
      content:"";
      position:absolute;
      top:0;
      width: 80px;
      height: 100%;
      z-index: 2;
      pointer-events:none;
    }

    .ticker:before{
      left:0;
      background: linear-gradient(90deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }
    .ticker:after{
      right:0;
      background: linear-gradient(270deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }

    .ticker-track{
      display:flex;
      gap: 18px;
      white-space: nowrap;
      will-change: transform;
      animation: tickerMove 26s linear infinite;
      padding-left: 16px;
    }

    /* Pause on hover (your requirement) */
    .ticker:hover .ticker-track{
      animation-play-state: paused;
    }

    @keyframes tickerMove{
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .tick{
      display:flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      font-size: 13px;
      color: #e9e6e2;
    }

    .tick .sym{
      font-weight: 900;
      letter-spacing: .02em;
      color: #f1efec;
      opacity: .95;
    }

    .tick .val{
      font-weight: 800;
      color: #fff;
    }

    .tick .chg{
      font-weight: 900;
      letter-spacing: .01em;
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }

    .chg.up{
      color: #20c997;
      background: rgba(32,201,151,.12);
    }
    .chg.down{
      color: #ff5c5c;
      background: rgba(255,92,92,.12);
    }
    .chg.flat{
      color: #c7c4bf;
      background: rgba(199,196,191,.10);
    }

    /* ---------- Section cards ---------- */
    .section{
      background: var(--cream);
      color: var(--onyx);
      border-radius: var(--radius-lg);
      padding: 26px;
      margin-bottom: 34px;
      box-shadow: var(--card-shadow);
    }

    .section h2{
      margin:0 0 6px;
      font-size: 20px;
      color: var(--onyx);
    }

    .section p{
      margin:0 0 18px;
      font-size: 13px;
      color: #444;
    }

    /* ---------- Form row / controls ---------- */
    .row{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .small{
      font-size: 12px;
      color: #555;
    }

    label.small{
      font-weight: 600;
      color: #333;
    }

    .input, input, select{
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      outline: none;
      min-height: 40px;
    }

    input.input{
      flex: 1 1 320px;
    }

    select{
      min-width: 160px;
    }

    button, .btn{
      font-family: inherit;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: #111;
      color: #fff;
      cursor: pointer;
      min-height: 40px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    button:hover, .btn:hover{ filter: brightness(1.05); }
    button:active, .btn:active{ transform: translateY(1px); }

    /* ---------- Panels ---------- */
    .panel{
      background: #f7f5f2;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--soft-shadow);
      border: 1px solid rgba(0,0,0,.06);
    }

    .panel-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title{
      font-weight: 800;
      letter-spacing: -.01em;
      color: #111;
    }

    .hint{
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }

    /* ---------- Key/Value grid ---------- */
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      margin-top: 12px;
      font-size: 13px;
    }

    .kv .k{ color: #444; }
    .kv .v{
      font-weight: 700;
      color: #111;
      text-align:right;
      white-space: nowrap;
    }

    /* ---------- Subcontractor Cards Grid ---------- */
    .grid-3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid-3{ grid-template-columns: 1fr; }
    }

    .card{
      background: #f5f3f0;
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--soft-shadow);
      transition: transform .25s ease, box-shadow .25s ease;
      border: 1px solid rgba(0,0,0,.05);
    }

    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 22px 50px rgba(0,0,0,.25);
    }

    .card h3{
      margin:0 0 6px;
      font-size: 16px;
      color: var(--onyx);
    }

    .meta{
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .card.clickable{ cursor: pointer; }

    .card.active{
      box-shadow:
        0 0 0 2px var(--burgundy),
        0 22px 50px rgba(0,0,0,.28);
    }

    /* ---------- Incidents ---------- */
    .inc-list{ margin-top: 10px; }

    .inc-row{
      display:grid;
      grid-template-columns: 1fr 1.2fr auto;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,.10);
      align-items:center;
    }
    @media (max-width: 760px){
      .inc-row{ grid-template-columns: 1fr; }
    }

    .link{
      color: var(--burgundy);
      font-weight: 700;
      text-decoration: none;
    }
    .link:hover{ text-decoration: underline; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      margin-left: 8px;
      vertical-align: middle;
    }
    .pill.high{ background:#f8d7da; color:#842029; }
    .pill.mod { background:#fff3cd; color:#856404; }
    .pill.low { background:#e7f5ec; color:#146c43; }

    /* ---------- Status ---------- */
    .status{
      margin-top: 14px;
      font-size: 12px;
      color: #6b6b6b;
    }
    .status.danger{
      color: #b42318;
      font-weight: 700;
    }
  
    /* ==============================
       IOI INSIGHTS (Neutral Telemetry)
    ============================== */
    .ioi-insights{
      margin-top: 14px;
      padding: 0 2px 6px;
    }
    .ioi-insight-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 1100px){
      .ioi-insight-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .ioi-insight-grid{ grid-template-columns: 1fr; }
    }
    .ioi-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius-lg);
      box-shadow: var(--soft-shadow);
      overflow:hidden;
      min-height: 210px;
      display:flex;
      flex-direction:column;
    }
    .ioi-card-h{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      gap: 10px;
    }
    .ioi-card-h .k{
      font-weight: 800;
      letter-spacing:.4px;
      font-size: 14px;
      text-transform: uppercase;
    }
    .ioi-card-h .meta{
      font-size: 12px;
      color: rgba(242,239,235,.75);
      white-space: nowrap;
    }
    .ioi-card-b{
      padding: 12px 16px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      flex:1;
    }
    .ioi-card-b .row{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:baseline;
    }
    .ioi-card-b .row.slim{
      margin-top: 2px;
      opacity: .92;
    }
    .ioi-card-b .label{
      font-size: 12px;
      color: rgba(242,239,235,.68);
      max-width: 55%;
    }
    .ioi-card-b .value{
      font-size: 14px;
      font-weight: 700;
      text-align:right;
      max-width: 45%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .ioi-card-f{
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap: 10px;
      align-items:center;
    }

    /* ---------- IOI mini tables ---------- */
    .mini-table{ width:100%; }
    table.mini{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    table.mini th, table.mini td{
      padding: 6px 6px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
    }
    table.mini thead th{
      color: rgba(255,255,255,.75);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    table.mini tbody td{
      color: rgba(255,255,255,.9);
    }
    table.mini tbody tr:hover td{
      background: rgba(255,255,255,.04);
    }
    .mini-btn{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--cream);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: .18s ease;
      white-space: nowrap;
    }
    .mini-btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); }
    .ioi-card-f .hint{
      font-size: 12px;
      color: rgba(242,239,235,.68);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex:1;
      min-width: 0;
    }

    /* Modal */
    .ioi-modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.64);
      backdrop-filter: blur(6px);
      z-index: 60;
      display:none;
    }
    .ioi-modal{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(980px, calc(100vw - 28px));
      max-height: min(80vh, 720px);
      background: rgba(17,17,18,.96);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.6);
      z-index: 61;
      display:none;
      overflow:hidden;
    }
    .ioi-modal-h{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .ioi-modal-h .title{
      font-weight: 900;
      letter-spacing:.4px;
      text-transform: uppercase;
      font-size: 13px;
    }
    .ioi-modal-h .close{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--cream);
      cursor:pointer;
      font-size: 20px;
      line-height: 1;
    }
    .ioi-modal-b{
      padding: 14px 16px 18px;
    }
    .ioi-modal-sub{
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .ioi-modal-note{
      color: rgba(242,239,235,.68);
      font-size: 12px;
      margin-bottom: 12px;
    }
    .ioi-table-wrap{
      overflow:auto;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
    }
    table.ioi-table{
      width:100%;
      border-collapse: collapse;
      min-width: 760px;
    }
    .ioi-table th, .ioi-table td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      vertical-align: top;
    }
    .ioi-table th{
      text-align:left;
      color: rgba(242,239,235,.78);
      font-weight: 900;
      letter-spacing:.3px;
      text-transform: uppercase;
      background: rgba(255,255,255,.03);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .ioi-table td.num, .ioi-table th.num{ text-align:right; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .ioi-badge{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 11px;
      margin-right: 6px;
    }


    /* ===========================
       TIME WINDOW TOGGLE
    =========================== */
    .window-toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 12px 0 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .win-btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--cream);
      font-weight: 900;
      letter-spacing: .06em;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      text-transform: uppercase;
    }
    .win-btn:hover{ background: rgba(255,255,255,.10); }
    .win-btn.active{
      background: rgba(159,28,31,.22);
      border-color: rgba(159,28,31,.35);
      box-shadow: inset 0 0 0 1px rgba(159,28,31,.18);
    }
    .win-meta{
      margin-left:auto;
      font-size: 12px;
      color: rgba(214,211,207,.78);
      white-space: nowrap;
    }

  </style>
</head>

<body>
  <header class="brand-header">
    <img src="coopersteel-logo.png" alt="Cooper Steel" class="brand-logo">
  </header>

  <div class="shell">
    <div class="container">

      <h1>2026 Safety Performance</h1>
      <p class="subhead">Real-time safety metrics across all active projects and subcontractors.</p>

      <div class="kpi-row" id="kpis">
        <div class="kpi"><div class="val">—</div><div class="lab">Total Man-Hours</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">TRIR</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">LTIR</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">Total Recordables</div></div>
        <div class="kpi"><div class="val">—</div><div class="lab">Active Subcontractors</div></div>
      </div>

      <!-- ✅ TIME WINDOW TOGGLE (Executive view) -->
      <div class="window-toggle" role="group" aria-label="Telemetry window">
        <button class="win-btn active" type="button" data-window="30" id="win30">30D</button>
        <button class="win-btn" type="button" data-window="60" id="win60">60D</button>
        <button class="win-btn" type="button" data-window="YTD" id="winYTD">YTD</button>
        <div class="win-meta" id="winMeta">Window: —</div>
      </div>

      <!-- ✅ IOI INSIGHTS (telemetry — neutral, factual) -->
      <div class="ioi-insights" id="ioiInsights" aria-label="IOI details">
        <div class="ioi-insight-grid">

          <div class="ioi-card" id="ioiCardWindow">
            <div class="ioi-card-h">
              <div class="k" id="ioiWindowTitle">Last 30 Days</div>
              <div class="meta" id="ioiWindowLabel">Window</div>
            </div>
            <div class="ioi-card-b">
              <div class="row"><div class="label">Total incidents</div><div class="value" id="tIncTotal">—</div></div>
              <div class="row"><div class="label">High / Mod / Low</div><div class="value" id="tSevMix">—</div></div>
              <div class="row"><div class="label">Top area (sub + project)</div><div class="value" id="tTopArea">—</div></div>
              <div class="row"><div class="label">Concentration (top area share)</div><div class="value" id="tConcShare">—</div></div>
            </div>
            <div class="ioi-card-f">
              <span class="muted">Distribution & shares</span>
            </div>
          </div>

          <div class="ioi-card" id="ioiCardTopSubs">
            <div class="ioi-card-h">
              <div class="k">Top Subcontractors</div>
              <div class="meta" id="ioiWindowMeta">Window incidents</div>
            </div>
            <div class="ioi-card-b">
              <div class="mini-table" id="tTopSubsTable">—</div>
            </div>
            <div class="ioi-card-f">
              <span class="muted">Counts by subcontractor</span>
            </div>
          </div>

          <div class="ioi-card" id="ioiCardTopProjects">
            <div class="ioi-card-h">
              <div class="k">Top Projects</div>
              <div class="meta" id="ioiWindowMeta">Window incidents</div>
            </div>
            <div class="ioi-card-b">
              <div class="mini-table" id="tTopProjectsTable">—</div>
            </div>
            <div class="ioi-card-f">
              <span class="muted">Counts by project</span>
            </div>
          </div>

          <div class="ioi-card" id="ioiCard10k">
            <div class="ioi-card-h">
              <div class="k">≥10,000 Hours Filter</div>
              <div class="meta">Subs w/ meaningful exposure</div>
            </div>
            <div class="ioi-card-b">
              <div class="row"><div class="label">Top sub (window incidents)</div><div class="value" id="tTop10kSub">—</div></div>
              <div class="row"><div class="label">Hours (YTD)</div><div class="value" id="tTop10kHours">—</div></div>
              <div class="row"><div class="label">Window incidents (that sub)</div><div class="value" id="tTop10kInc">—</div></div>
              <div class="row"><div class="label">Data source</div><div class="value">SUBS + INCIDENTS</div></div>
            </div>
            <div class="ioi-card-f">
              <span class="muted">Filtered ranking</span>
            </div>
          </div>

        </div>
      </div>
<div class="section">
        <h2>Subcontractor Performance</h2>
        <p>Top subcontractors by hours are shown below. Use the lookup to view any subcontractor.</p>

        <div class="row">
          <label class="small" for="subPick">Subcontractor</label>
          <input class="input" id="subPick" list="subList" placeholder="Type a subcontractor name…" autocomplete="off" />
          <datalist id="subList"></datalist>
        </div>

        <div class="panel" id="subDetail" style="margin-top:12px;">
          <div class="title">Select a subcontractor</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        </div>

        <div style="height:16px"></div>
        <div class="grid-3" id="subCards"></div>
        <div class="status" id="subHint"></div>

        <div class="panel" id="subIncPanel" style="display:none; margin-top:14px;">
          <div class="panel-head">
            <div>
              <div class="title" id="subIncTitle">Incidents —</div>
              <div class="hint" id="subIncHint">Showing incidents for selected subcontractor.</div>
            </div>
            <button class="btn" id="subIncClose" type="button">Close</button>
          </div>
          <div id="subIncList"></div>
        </div>
      </div>


      <div class="section">
        <h2>Incidents</h2>
        <p>Latest incidents shown. Search by subcontractor, project, or incident ID.</p>

        <div class="row">
          <input class="input" id="q" placeholder="Search incidents (sub, project, ID)" autocomplete="off" />
          <select id="sev">
            <option value="">Severity: All</option>
            <option value="High">High</option>
            <option value="Moderate">Moderate</option>
            <option value="Low">Low</option>
          </select>
          <button id="clear">Clear</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="small" for="incPick">Incident</label>
          <input class="input" id="incPick" list="incList" placeholder="Type an Incident ID…" autocomplete="off" />
          <datalist id="incList"></datalist>
        </div>

        <div class="panel" id="incDetail" style="margin-top:12px;">
          <div class="title">Select an incident</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        </div>

        <div class="inc-list" id="incidentList"></div>
        <div class="status" id="incHint"></div>

        <div style="margin-top:12px" class="small">
          Click “View report” to see the incident report details.
        </div>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    /*** CONFIG: your published CSV URLs ***/
    const KPI_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=152373673&single=true&output=csv";
    const SUBS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=466735545&single=true&output=csv";
    const INCIDENTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=1844704592&single=true&output=csv";

    /* ✅ PASTE YOUR PUB_IOI PUBLISHED CSV LINK HERE */
    const IOI_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=303885721&single=true&output=csv";

    /*** helpers ***/
    const bust = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

    function setStatus(msg, isErr=false){
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.className = "status" + (isErr ? " danger" : "");
    }

    function toNumber(x){
      if (x === null || x === undefined) return 0;
      const n = parseFloat(String(x).replace(/,/g,"").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(x){
      return (x === null || x === undefined) ? "" : String(x);
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const next = text[i+1];

        if (c === '"' ){
          if (inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && c === "," ){
          row.push(cur); cur = ""; continue;
        }
        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r"  && next === "\n")  i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }
        cur += c;
      }
      row.push(cur);
      rows.push(row);
      return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
    }

    async function fetchTable(url){
      const res = await fetch(bust(url), { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status);
      const txt = await res.text();
      const grid = parseCSV(txt);

      if (!grid.length) return [];
      const headers = grid[0].map(h => String(h).trim());
      const out = [];

      for (let i=1; i<grid.length; i++){
        const obj = {};
        for (let j=0; j<headers.length; j++){
          obj[headers[j] || ("col"+j)] = (grid[i][j] ?? "").trim();
        }
        out.push(obj);
      }
      return out;
    }

    /*** KPI ***/
    function renderKPIs(kpis){
      const map = {};
      kpis.forEach(r => { map[r.Metric] = r.Value; });

      const kpiEls = document.getElementById("kpis").querySelectorAll(".kpi .val");
      const totalHours = safeText(map["Total Man-Hours"] ?? "—");
      const trir = safeText(map["TRIR"] ?? "—");
      const ltir = safeText(map["LTIR"] ?? "—");
      const rec = safeText(map["Total Recordables"] ?? "—");
      const active = safeText(map["Active Subcontractors"] ?? "—");

      kpiEls[0].textContent = totalHours;
      kpiEls[1].textContent = trir;
      kpiEls[2].textContent = ltir;
      kpiEls[3].textContent = rec;
      kpiEls[4].textContent = active;
    }

    /*** IOI TICKER ***/
    function fmt(n, d=2){
      const num = parseFloat(n);
      if (!Number.isFinite(num)) return safeText(n) || "—";
      return num.toFixed(d);
    }

    function buildTick(label, value, delta){
      const d = parseFloat(delta);
      let cls = "flat", arrow = "•", sign = "";
      if (Number.isFinite(d)){
        if (d > 0){ cls = "up"; arrow = "▲"; sign = "+"; }
        else if (d < 0){ cls = "down"; arrow = "▼"; sign = ""; }
      } else {
        delta = "";
      }

      const deltaTxt = (delta === "" || delta === null || delta === undefined)
        ? ""
        : `${arrow} ${sign}${fmt(d,2)}`;

      return `
        <div class="tick">
          <span class="sym">${label}</span>
          <span class="val">${value}</span>
          <span class="chg ${cls}">${deltaTxt || "• —"}</span>
        </div>
      `;
    }

    
    /*** IOI INSIGHTS (neutral + factual) ***/
    let INC_NORM = [];

    function parseDateAny(s){
      if (!s) return null;
      const str = String(s).trim();
      // Try native first
      let d = new Date(str);
      if (!isNaN(d)) return d;
      // Try MM/DD/YYYY or M/D/YYYY
      const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
      if (m){
        const mm = parseInt(m[1],10) - 1;
        const dd = parseInt(m[2],10);
        let yy = parseInt(m[3],10);
        if (yy < 100) yy += 2000;
        d = new Date(yy, mm, dd);
        return isNaN(d) ? null : d;
      }
      return null;
    }

    function fmtDelta(x, decimals=2){
      const n = toNumber(x);
      if (!Number.isFinite(n) || n === 0) return "• Δ 0";
      const sign = n > 0 ? "+" : "";
      return (n > 0 ? "▲ " : "▼ ") + "Δ " + sign + n.toFixed(decimals);
    }

    function openDriversModal(title, note, rows){
      const back = document.getElementById("ioiDriversBack");
      const modal = document.getElementById("ioiDriversModal");
      const t = document.getElementById("ioiDriversTitle");
      const sub = document.getElementById("ioiDriversSub");
      const n = document.getElementById("ioiDriversNote");
      const body = document.getElementById("ioiDriversTbody");
      if (!back || !modal || !t || !sub || !n || !body) return;

      t.textContent = "IOI Drivers";
      sub.textContent = title || "Drivers";
      n.textContent = note || "Drivers are computed from incident distribution in the last 30 days (Date field). Values are counts and shares; no narrative interpretation.";

      body.innerHTML = "";
      if (!rows || !rows.length){
        body.innerHTML = `<tr><td colspan="4" style="color:rgba(242,239,235,.7);padding:14px 12px;">No driver data available for the current window.</td></tr>`;
      } else {
        body.innerHTML = rows.map(r => {
          const sev = r.sevMix || "—";
          return `
            <tr>
              <td>${escapeHtml(r.area)}</td>
              <td class="num">${r.count}</td>
              <td class="num">${r.share}</td>
              <td>${sev}</td>
            </tr>
          `;
        }).join("");
      }

      back.style.display = "block";
      modal.style.display = "block";
      back.setAttribute("aria-hidden","false");
      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";

      const close = document.getElementById("ioiDriversClose");
      if (close) close.focus();
    }

    function closeDriversModal(){
      const back = document.getElementById("ioiDriversBack");
      const modal = document.getElementById("ioiDriversModal");
      if (!back || !modal) return;
      back.style.display = "none";
      modal.style.display = "none";
      back.setAttribute("aria-hidden","true");
      modal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";

      // return focus to explainer button if exists, otherwise nothing
      const btn = document.getElementById("win30");
      if (btn) btn.focus();
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[ch]));
    }

    function computeDriversLast30(incRows){
      // Window: [today-29, today]
      const end = new Date();
      end.setHours(23,59,59,999);
      const start = new Date(end);
      start.setDate(start.getDate() - 29);
      start.setHours(0,0,0,0);

      const inWindow = (incRows || []).filter(r => {
        const d = parseDateAny(r.Date);
        return d && d >= start && d <= end;
      });

      const total = inWindow.length || 0;

      const byArea = new Map(); // key -> {count, sev: {high/mod/low/other}}
      function bump(key, sev){
        const k = key || "—";
        const rec = byArea.get(k) || {count:0, sev:{}};
        rec.count += 1;
        const s = (sev || "Unspecified").toLowerCase();
        rec.sev[s] = (rec.sev[s] || 0) + 1;
        byArea.set(k, rec);
      }

      for (const r of inWindow){
        const sub = (r.Subcontractor || "—").trim();
        const proj = (r.Project || "—").trim();
        const area = `${sub} • ${proj}`;
        bump(area, r.Severity);
      }

      const rows = Array.from(byArea.entries())
        .map(([area, v]) => {
          const share = total ? (v.count/total) : 0;
          const sevPairs = Object.entries(v.sev).sort((a,b)=>b[1]-a[1]);
          const sevMix = sevPairs.slice(0,3).map(([k,c])=>`${k}:${c}`).join("  ");
          return {
            area,
            count: v.count,
            shareRaw: share,
            share: (share*100).toFixed(0) + "%",
            sevMix: sevMix || "—"
          };
        })
        .sort((a,b)=> b.count - a.count || b.shareRaw - a.shareRaw);

      const top = rows[0] || null;

      return {
        start,
        end,
        total,
        rows,
        top
      };
    }

    
function computeTelemetryWindow(incNorm, subsAll, window){
      const parsed = (d)=>{
        const t = Date.parse(d);
        return isNaN(t) ? null : new Date(t);
      };

      const dates = incNorm.map(x => parsed(x.Date)).filter(Boolean);
      const end = dates.length ? new Date(Math.max(...dates.map(d=>d.getTime()))) : new Date();
      end.setHours(23,59,59,999);

      let start;
      let label;

      if (String(window).toUpperCase() === "YTD"){
        start = new Date(end.getFullYear(), 0, 1);
        start.setHours(0,0,0,0);
        label = "YTD";
      } else {
        const days = Math.max(1, Number(window) || 30);
        start = new Date(end);
        start.setDate(start.getDate() - (days - 1));
        start.setHours(0,0,0,0);
        label = `${days}D`;
      }

      const inWin = incNorm.filter(x=>{
        const d = parsed(x.Date);
        if(!d) return false;
        d.setHours(12,0,0,0); // normalize midday to avoid DST edge weirdness
        return d >= start && d <= end;
      });

      const total = inWin.length;

      const sevBucket = (s)=>{
        const v = String(s||"").trim().toLowerCase();
        if(!v) return "unknown";
        if(v.includes("high")) return "high";
        if(v.includes("mod")) return "moderate";
        if(v.includes("low")) return "low";
        return v;
      };

      const sev = {high:0, moderate:0, low:0, unknown:0};
      const bySub = new Map();
      const byProj = new Map();
      const byArea = new Map(); // sub + project

      for (const it of inWin){
        const s = (it.Subcontractor||"—").trim() || "—";
        const p = (it.Project||"—").trim() || "—";
        const a = `${s} • ${p}`;
        bySub.set(s, (bySub.get(s)||0)+1);
        byProj.set(p, (byProj.get(p)||0)+1);
        byArea.set(a, (byArea.get(a)||0)+1);

        const b = sevBucket(it.Severity);
        if(sev[b] === undefined) sev.unknown++;
        else sev[b]++;
      }

      const topFromMap = (mp, n=5)=> [...mp.entries()]
        .sort((a,b)=> b[1]-a[1])
        .slice(0,n)
        .map(([name,count])=> ({name, count}));

      const topSubs = topFromMap(bySub, 5);
      const topProjects = topFromMap(byProj, 5);
      const topAreas = topFromMap(byArea, 10);

      const topArea = topAreas[0] || null;
      const topAreaShare = topArea && total ? (topArea.count/total) : null;

      // ≥10k filter using SUBS (YTD hours) + window incident counts
      const subs10k = (subsAll||[])
        .filter(s => (Number(s.hours)||0) >= 10000)
        .map(s => {
          const c = bySub.get(s.sub) || 0;
          return { sub: s.sub, hours: Number(s.hours)||0, incWin: c };
        })
        .sort((a,b)=> b.incWin - a.incWin || b.hours - a.hours);

      const top10k = subs10k[0] || null;

      return {
        windowLabel: label,
        start, end, total,
        sev,
        topSubs,
        topProjects,
        topAreas,
        topArea,
        topAreaShare,
        subs10k,
        top10k
      };
    }

    function fmtPct(x){
      if (x === null || x === undefined) return "—";
      return (x*100).toFixed(1) + "%";
    }

    function buildMiniTable(rows, total){
      if(!rows || !rows.length) return `<div class="small">No data in window.</div>`;
      return `
        <table class="mini">
          <thead><tr><th>Rank</th><th>Name</th><th>Count</th><th>Share</th></tr></thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr>
                <td class="mono">${i+1}</td>
                <td>${safeText(r.name||r.sub||"—")}</td>
                <td class="mono">${r.count ?? r.incWin ?? 0}</td>
                <td class="mono">${total ? fmtPct(((r.count ?? r.incWin ?? 0)/total)) : "—"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderTelemetry(tele){
      // Insights
      const winEl = document.getElementById("ioiWindowLabel");
      const tIncTotal = document.getElementById("tIncTotal");
      const tSevMix = document.getElementById("tSevMix");
      const tTopArea = document.getElementById("tTopArea");
      const tConcShare = document.getElementById("tConcShare");
      const tTopSubsTable = document.getElementById("tTopSubsTable");
      const tTopProjectsTable = document.getElementById("tTopProjectsTable");
      const tTop10kSub = document.getElementById("tTop10kSub");
      const tTop10kHours = document.getElementById("tTop10kHours");
      const tTop10kInc = document.getElementById("tTop10kInc");

      if(!tele){
        if(winEl) winEl.textContent = "Window";
        if(tIncTotal) tIncTotal.textContent = "—";
        if(tSevMix) tSevMix.textContent = "—";
        if(tTopArea) tTopArea.textContent = "—";
        if(tConcShare) tConcShare.textContent = "—";
        if(tTopSubsTable) tTopSubsTable.innerHTML = "—";
        if(tTopProjectsTable) tTopProjectsTable.innerHTML = "—";
        if(tTop10kSub) tTop10kSub.textContent = "—";
        if(tTop10kHours) tTop10kHours.textContent = "—";
        if(tTop10kInc) tTop10kInc.textContent = "—";
        return;
      }

      const winTxt = `${tele.start.toLocaleDateString()} → ${tele.end.toLocaleDateString()}`;
      if(winEl) winEl.textContent = winTxt;

      if(tIncTotal) tIncTotal.textContent = String(tele.total ?? 0);
      if(tSevMix) tSevMix.textContent = `${tele.sev.high||0} / ${tele.sev.moderate||0} / ${tele.sev.low||0}`;
      if(tTopArea) tTopArea.textContent = tele.topArea ? tele.topArea.name : "—";
      if(tConcShare) tConcShare.textContent = tele.topAreaShare !== null ? fmtPct(tele.topAreaShare) : "—";

      if(tTopSubsTable) tTopSubsTable.innerHTML = buildMiniTable(tele.topSubs, tele.total);
      if(tTopProjectsTable) tTopProjectsTable.innerHTML = buildMiniTable(tele.topProjects, tele.total);

      if(tele.top10k){
        if(tTop10kSub) tTop10kSub.textContent = tele.top10k.sub || "—";
        if(tTop10kHours) tTop10kHours.textContent = fmt(tele.top10k.hours,0);
        if(tTop10kInc) tTop10kInc.textContent = String(tele.top10k.incWin ?? 0);
      } else {
        if(tTop10kSub) tTop10kSub.textContent = "—";
        if(tTop10kHours) tTop10kHours.textContent = "—";
        if(tTop10kInc) tTop10kInc.textContent = "—";
      }

    }
    }


     
    
/*** SUBS ***/
    let SUBS_ALL = [];

    function normalizeSubsRows(rows){
      return rows.map(r => {
        const sub = r.Subcontractor || r.subcontractor || r.Sub || r.SUB || r.Name || r.name || "";
        const hours = toNumber(r.TotalHours ?? r.Hours ?? r.hours ?? 0);
        const incidents = toNumber(r.TotalIncidents ?? r.Incidents ?? r.incidents ?? 0);
        const recordables = toNumber(r.Recordables ?? r.recordables ?? 0);
        const lost = toNumber(r.LostTime ?? r.Lost ?? r.losttime ?? 0);
        const trir = safeText(r.TRIR ?? r.trir ?? "");
        const ltir = safeText(r.LTIR ?? r.ltir ?? "");
        return {
          sub: String(sub).trim(),
          hours,
          incidents,
          recordables,
          lost,
          trir: (trir === "" ? "" : String(trir)),
          ltir: (ltir === "" ? "" : String(ltir))
        };
      }).filter(x => x.sub && x.sub.toLowerCase() !== "subcontractor");
    }

    function renderSubDetail(item){
      const box = document.getElementById("subDetail");
      if (!item){
        box.innerHTML = `
          <div class="title">Select a subcontractor</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="title">${item.sub}</div>
        <div class="hint">YTD exposure & rates</div>
        <div class="kv">
          <div class="k">Hours</div><div class="v">${item.hours.toLocaleString()}</div>
          <div class="k">Incidents</div><div class="v">${item.incidents}</div>
          <div class="k">Recordables</div><div class="v">${item.recordables}</div>
          <div class="k">Lost Time</div><div class="v">${item.lost}</div>
          <div class="k">TRIR</div><div class="v">${item.trir || "0"}</div>
          <div class="k">LTIR</div><div class="v">${item.ltir || "0"}</div>
        </div>
      `;
    }

    function renderSubs(rows){
      SUBS_ALL = normalizeSubsRows(rows);

      const dl = document.getElementById("subList");
      dl.innerHTML = [...SUBS_ALL]
        .sort((a,b)=> a.sub.localeCompare(b.sub))
        .map(r => `<option value="${r.sub}"></option>`)
        .join("");

      const top = [...SUBS_ALL].sort((a,b)=> b.hours - a.hours).slice(0, 9);
      const wrap = document.getElementById("subCards");
      wrap.innerHTML = top.map(r => `
        <div class="card clickable" data-sub="${r.sub}">
          <h3>${r.sub}</h3>
          <div class="meta">YTD exposure & rates</div>
          <div class="kv">
            <div class="k">Hours</div><div class="v">${r.hours.toLocaleString()}</div>
            <div class="k">Incidents</div><div class="v">${r.incidents}</div>
            <div class="k">Recordables</div><div class="v">${r.recordables}</div>
            <div class="k">TRIR</div><div class="v">${r.trir || "0"}</div>
            <div class="k">LTIR</div><div class="v">${r.ltir || "0"}</div>
          </div>
        </div>
      `).join("");

      [...wrap.querySelectorAll(".card.clickable")].forEach(card=>{
        card.addEventListener("click", ()=>{
          const sub = card.dataset.sub || "";
          setActiveSubCard(sub);
          openSubIncidentsPanel(sub);
        });
      });

      document.getElementById("subHint").textContent =
        `Showing top ${top.length} by hours. Use lookup to view any of ${SUBS_ALL.length} subcontractors.`;

      const pick = document.getElementById("subPick");
      if (!pick.dataset.wired){
        pick.dataset.wired = "1";
        const apply = () => {
          const v = (pick.value || "").trim().toLowerCase();
          const found = SUBS_ALL.find(x => x.sub.toLowerCase() === v);
          renderSubDetail(found || null);
        };
        pick.addEventListener("change", apply);
        pick.addEventListener("blur", apply);
        pick.addEventListener("keydown", (e)=>{ if (e.key === "Enter") apply(); });
      }
    }

    /*** INCIDENTS ***/
    let INC_ALL = [];
    let ACTIVE_SUB = "";

    function setActiveSubCard(sub){
      ACTIVE_SUB = sub || "";
      document.querySelectorAll("#subCards .card.clickable").forEach(el=>{
        if ((el.dataset.sub || "") === ACTIVE_SUB) el.classList.add("active");
        else el.classList.remove("active");
      });
    }

    function pillForSeverity(sev){
      const s = (sev || "").toLowerCase();
      if (s === "high") return `<span class="pill high">High</span>`;
      if (s === "moderate") return `<span class="pill mod">Moderate</span>`;
      if (s === "low") return `<span class="pill low">Low</span>`;
      return "";
    }

    function openSubIncidentsPanel(sub){
      const panel = document.getElementById("subIncPanel");
      const title = document.getElementById("subIncTitle");
      const hint = document.getElementById("subIncHint");
      const list = document.getElementById("subIncList");

      const s = (sub || "").trim();
      title.textContent = s ? `Incidents — ${s}` : "Incidents —";
      panel.style.display = "block";

      const rows = [...INC_ALL]
        .filter(r => String(r.Subcontractor || "").trim().toLowerCase() === s.toLowerCase())
        .sort((a,b)=> String(b.Date||"").localeCompare(String(a.Date||"")));

      hint.textContent = rows.length ? `${rows.length} incident(s) found.` : "No incidents found for this subcontractor.";

      if (!rows.length){
        list.innerHTML = `<div class="small">No incidents match.</div>`;
        return;
      }

      const cap = 25;
      const shown = rows.slice(0, cap);

      list.innerHTML = shown.map(r => `
        <div class="inc-row">
          <div>
            <strong>${safeText(r.Date) || "—"}</strong>
            <div class="meta">${safeText(r.IncidentID) || "—"}</div>
          </div>
          <div>
            <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
            <div class="meta">${safeText(r.Project) || ""}</div>
          </div>
          <div style="text-align:right;">
            ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
          </div>
        </div>
      `).join("");

      if (rows.length > cap){
        list.innerHTML += `<div class="small" style="padding-top:10px;">Showing first ${cap}. Refine using the Incidents search below if needed.</div>`;
      }
    }

    function normalizeIncidentRows(rows){
      return rows.map(r => ({
        Date: r.Date || r.date || "",
        IncidentID: r.IncidentID || r.IncidentId || r.ID || r.Id || "",
        Subcontractor: r.Subcontractor || r.subcontractor || r.Sub || "",
        Project: r.Project || r.project || "",
        Severity: r.Severity || r.severity || "",
        ReportLink: r.ReportLink || r.reportlink || r.Link || ""
      })).filter(x => x.IncidentID && String(x.IncidentID).trim().toLowerCase() !== "incidentid");
    }

    function renderIncidentDetail(item){
      const box = document.getElementById("incDetail");
      if(!item){
        box.innerHTML = `
          <div class="title">Select an incident</div>
          <div class="hint">Details will appear here.</div>
          <div class="small">No selection.</div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="title">${safeText(item.IncidentID) || "—"}</div>
        <div class="hint">${safeText(item.Date) || ""} • ${safeText(item.Severity) || "—"} • ${safeText(item.Subcontractor) || "—"}</div>
        <div class="kv">
          <div class="k">Project</div><div class="v">${safeText(item.Project) || "—"}</div>
          <div class="k">Subcontractor</div><div class="v">${safeText(item.Subcontractor) || "—"}</div>
          <div class="k">Severity</div><div class="v">${safeText(item.Severity) || "—"}</div>
          <div class="k">Date</div><div class="v">${safeText(item.Date) || "—"}</div>
        </div>
        <div style="margin-top:12px;">
          ${item.ReportLink
            ? `<a class="link" href="${item.ReportLink}" target="_blank" rel="noopener">View report</a>`
            : `<span class="small">No report link</span>`}
        </div>
      `;
    }

    function renderIncidentsLookup(rows){
      INC_ALL = normalizeIncidentRows(rows);

      const dl = document.getElementById("incList");
      dl.innerHTML = [...INC_ALL]
        .sort((a,b)=> String(a.IncidentID).localeCompare(String(b.IncidentID)))
        .map(r => `<option value="${safeText(r.IncidentID)}"></option>`)
        .join("");

      const pick = document.getElementById("incPick");
      if(!pick.dataset.wired){
        pick.dataset.wired = "1";
        const apply = () => {
          const v = (pick.value || "").trim().toLowerCase();
          const found = INC_ALL.find(x => String(x.IncidentID || "").trim().toLowerCase() === v);
          renderIncidentDetail(found || null);
        };
        pick.addEventListener("change", apply);
        pick.addEventListener("blur", apply);
        pick.addEventListener("keydown", (e)=>{ if(e.key==="Enter") apply(); });
      }
    }

    function renderIncidentsTable(allIncidents){
      const q = document.getElementById("q").value.trim().toLowerCase();
      const sev = document.getElementById("sev").value;

      let rows = normalizeIncidentRows(allIncidents);

      if (sev) rows = rows.filter(r => (r.Severity || "") === sev);

      if (q){
        rows = rows.filter(r => (
          String(r.IncidentID || "").toLowerCase().includes(q) ||
          String(r.Subcontractor || "").toLowerCase().includes(q) ||
          String(r.Project || "").toLowerCase().includes(q)
        ));
      }

      rows.sort((a,b)=>{
        const da = Date.parse(a.Date) || 0;
        const db = Date.parse(b.Date) || 0;
        return db - da;
      });

      const cap = (q || sev) ? 10 : 5;
      const shown = rows.slice(0, cap);

      document.getElementById("incHint").textContent =
        (q || sev)
          ? `Showing top ${Math.min(cap, rows.length)} matches (capped).`
          : "Showing latest 5 incidents.";

      const list = document.getElementById("incidentList");
      if (!shown.length){
        list.innerHTML = `<div class="small" style="padding:12px 0;">No incidents match your filters.</div>`;
        return;
      }

      list.innerHTML = shown.map(r => `
        <div class="inc-row">
          <div>
            <strong>${safeText(r.Date) || "—"}</strong>
            <div class="meta">${safeText(r.IncidentID) || "—"}</div>
          </div>
          <div>
            <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
            <div class="meta">${safeText(r.Project) || ""}</div>
          </div>
          <div style="text-align:right;">
            ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
          </div>
        </div>
      `).join("");
    }

    /*** init ***/
    (async function init(){
      try {
        setStatus("Loading data…");

        const [kpis, subs, inc] = await Promise.all([
          fetchTable(KPI_CSV),
          fetchTable(SUBS_CSV),
          fetchTable(INCIDENTS_CSV)
        ]);

        // Normalize incidents once for IOI drivers (neutral rollup)
        INC_NORM = normalizeIncidentRows(inc);

        renderKPIs(kpis);
        renderSubs(subs);

        // Incidents
        renderIncidentsTable(inc);
        renderIncidentsLookup(inc);

        // Auto-select latest incident into detail panel
        const latest = normalizeIncidentRows(inc).sort((a,b)=>{
          const da = Date.parse(a.Date) || 0;
          const db = Date.parse(b.Date) || 0;
          return db - da;
        })[0];
        if (latest) renderIncidentDetail(latest);

        // Sub incident panel close
        const subClose = document.getElementById("subIncClose");
        subClose.addEventListener("click", ()=>{
          document.getElementById("subIncPanel").style.display = "none";
          setActiveSubCard("");
        });

        document.getElementById("q").addEventListener("input", ()=>renderIncidentsTable(inc));
        document.getElementById("sev").addEventListener("change", ()=>renderIncidentsTable(inc));
        document.getElementById("clear").addEventListener("click", (e)=>{
          e.preventDefault();
          document.getElementById("q").value = "";
          document.getElementById("sev").value = "";
          renderIncidentsTable(inc);
        });

        // ✅ Telemetry (windowed) from INCIDENTS + SUBS
        let ACTIVE_WINDOW = 30; // 30 | 60 | "YTD"

        function setActiveWindow(win){
          ACTIVE_WINDOW = win;

          // button state
          document.querySelectorAll(".win-btn").forEach(b=>b.classList.remove("active"));
          const btn = (win === 30) ? document.getElementById("win30")
                    : (win === 60) ? document.getElementById("win60")
                    : document.getElementById("winYTD");
          if (btn) btn.classList.add("active");

          updateTelemetry();
        }

        function updateTelemetry(){
          const win = (ACTIVE_WINDOW === "YTD") ? "YTD" : ACTIVE_WINDOW;
          const tele = computeTelemetryWindow(INC_NORM, SUBS_ALL, win);
          renderTelemetry(tele);

          // update labels
          const title = document.getElementById("ioiWindowTitle");
          const meta = document.getElementById("ioiWindowMeta");
          const wm = document.getElementById("winMeta");
          const winLabel = (ACTIVE_WINDOW === "YTD") ? "YTD" : `${ACTIVE_WINDOW}D`;

          if (title) title.textContent = (ACTIVE_WINDOW === "YTD") ? "Year to Date" : `Last ${ACTIVE_WINDOW} Days`;
          if (meta) meta.textContent = "Window incidents";
          if (wm) wm.textContent = `Window: ${tele.start.toLocaleDateString()} → ${tele.end.toLocaleDateString()} (${winLabel})`;
        }

        // Wire toggle buttons (once)
        document.querySelectorAll(".win-btn").forEach(btn=>{
          if (btn.dataset.wired === "1") return;
          btn.dataset.wired = "1";
          btn.addEventListener("click", ()=>{
            const w = btn.getAttribute("data-window");
            if (!w) return;
            if (w === "YTD") setActiveWindow("YTD");
            else setActiveWindow(Number(w) || 30);
          });
        });

        // initial render
        setActiveWindow(30);
        setStatus("");
      } catch (err){
        console.error(err);
        setStatus("Data fetch failed. Check CSV publish links, then refresh.", true);
        document.getElementById("subHint").textContent = "Could not load subcontractor data. Verify your published SUBS CSV.";
        document.getElementById("incHint").textContent = "Could not load incidents. Verify your published INCIDENTS CSV.";
      }
    })();
  </script>
</body>
</html>









