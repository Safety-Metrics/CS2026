<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Safety Performance</title>

  <!-- Optional: helps prevent some injection vectors if hosted with proper headers.
       (Real CSP should be set as HTTP header by server for best protection.)
  -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <style>
    /* ==============================
      COOPER STEEL – 2026 DASHBOARD
      Executive / Premium Theme (CLEAN)
      IOI ticker + explainer panel
      Security + Accessibility upgrades
    ============================== */

    :root{
      --cream: #F2EFEB;
      --cloud: #CFCDCA;
      --cooper-red: #9F1C1F;
      --burgundy: #680C19;
      --onyx: #111112;
      --charcoal: #282828;
      --steel-gray: #5D5C5A;

      --radius-lg: 20px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --card-shadow: 0 18px 40px rgba(0,0,0,.45);
      --soft-shadow: 0 10px 28px rgba(0,0,0,.28);

      --glass: rgba(0,0,0,.45);
      --glass-2: rgba(0,0,0,.28);

      --line: rgba(255,255,255,.10);

      --ok: #20c997;
      --warn: #ffd27b;
      --bad: #ff5c5c;

      --muted: rgba(214,211,207,.78);

      --skeleton: rgba(255,255,255,.08);
      --skeleton-2: rgba(255,255,255,.05);
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(159,28,31,.32), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(104,12,25,.38), transparent 65%),
        linear-gradient(180deg, #0c0c0d 0%, #141414 100%);
      color: var(--cream);
    }

    a{ color: inherit; }

    /* ---------- Top Logo Header ---------- */
    header.brand-header{
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 26px 16px 6px;
    }

    .brand-logo{
      height: clamp(110px, 10vw, 175px);
      width: auto;
      display:block;
      filter:
        drop-shadow(0 2px 3px rgba(255,255,255,.25))
        drop-shadow(0 0 22px rgba(159,28,31,.55))
        drop-shadow(0 0 44px rgba(159,28,31,.25))
        drop-shadow(0 16px 34px rgba(0,0,0,.45));
      animation: brandFloat 4.2s ease-in-out infinite;
    }

    @keyframes brandFloat{
      0%,100% { transform: translateY(0) scale(1); }
      50%     { transform: translateY(-2px) scale(1.01); }
    }

    @media (prefers-reduced-motion: reduce){
      .brand-logo{ animation:none; }
    }

    /* ---------- Shell / Container ---------- */
    .shell{ width: 100%; }
    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 22px 80px;
    }

    /* ---------- Headings ---------- */
    h1{
      margin: 10px 0 6px;
      font-size: 36px;
      letter-spacing: -.02em;
      color: var(--cream);
    }

    .subhead{
      font-size: 14px;
      color: #d6d3cf;
      margin-bottom: 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .updated{
      font-size: 12px;
      color: rgba(214,211,207,.70);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }

    .dot-live{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(32,201,151,.9);
      box-shadow: 0 0 0 3px rgba(32,201,151,.16);
    }

    /* ---------- KPI Row ---------- */
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 14px;
      margin: 18px 0 14px;
    }

    .kpi{
      background: rgba(0,0,0,.45);
      border-radius: 14px;
      padding: 16px 16px 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      min-width: 0;
    }

    .kpi .val{
      font-size: 20px;
      font-weight: 700;
      color: var(--cream);
      letter-spacing: -.01em;
      line-height: 1.15;
    }

    .kpi .lab{
      margin-top: 6px;
      font-size: 12px;
      color: #bfbab5;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .kpi-row{ grid-template-columns: 1fr; }
    }

    /* ---------- Skeleton ---------- */
    .skeleton{
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, var(--skeleton) 0%, var(--skeleton-2) 50%, var(--skeleton) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.1s ease-in-out infinite;
      border-radius: 10px;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }
    @media (prefers-reduced-motion: reduce){
      .skeleton{ animation:none; }
    }

    .kpi .val.skel{
      height: 22px;
      width: 70%;
    }

    /* ===========================
       IOI TICKER (Stock Tape)
    =========================== */

    .ioi-wrap{ margin: 10px 0 26px; }

    .ioi-title{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 2px 10px;
      flex-wrap: wrap;
    }

    .ioi-title h3{
      margin:0;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #d8d4cf;
      opacity: .95;
    }

    .ioi-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ioi-sub{
      font-size: 12px;
      color: rgba(214,211,207,.75);
    }

    .ioi-info-btn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.06);
      color: #f1efec;
      font-weight: 800;
      letter-spacing: .02em;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      user-select: none;
      white-space: nowrap;
    }
    .ioi-info-btn:hover{ background: rgba(255,255,255,.09); }
    .ioi-info-btn:active{ transform: translateY(1px); }
    .ioi-info-btn .dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(159,28,31,.18);
      color: #ffd7d7;
      font-size: 12px;
      font-weight: 900;
      box-shadow: inset 0 0 0 1px rgba(159,28,31,.28);
    }

    .ticker{
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      background: rgba(0,0,0,.42);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      padding: 10px 0;
    }

    .ticker:before,
    .ticker:after{
      content:"";
      position:absolute;
      top:0;
      width: 80px;
      height: 100%;
      z-index: 2;
      pointer-events:none;
    }
    .ticker:before{
      left:0;
      background: linear-gradient(90deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }
    .ticker:after{
      right:0;
      background: linear-gradient(270deg, rgba(12,12,13,1) 0%, rgba(12,12,13,0) 100%);
      opacity:.35;
    }

    .ticker-track{
      display:flex;
      gap: 18px;
      white-space: nowrap;
      padding-left: 16px;
      will-change: transform;
    }

    /* We drive motion via JS to avoid the “-50% assumes exact width” issue. */
    .tick{
      display:flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      font-size: 13px;
      color: #e9e6e2;
      flex: 0 0 auto;
    }

    .tick .sym{
      font-weight: 900;
      letter-spacing: .02em;
      color: #f1efec;
      opacity: .95;
    }
    .tick .val{
      font-weight: 800;
      color: #fff;
    }

    .tick .chg{
      font-weight: 900;
      letter-spacing: .01em;
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .chg.up{
      color: var(--ok);
      background: rgba(32,201,151,.12);
    }
    .chg.down{
      color: var(--bad);
      background: rgba(255,92,92,.12);
    }
    .chg.flat{
      color: #c7c4bf;
      background: rgba(199,196,191,.10);
    }

    /* ---------- IOI Explainer Panel ---------- */
    .ioi-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .ioi-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    .ioi-panel{
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(520px, 92vw);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(159,28,31,.18), transparent 55%),
        radial-gradient(700px 420px at 80% 20%, rgba(104,12,25,.18), transparent 60%),
        linear-gradient(180deg, rgba(14,14,15,1) 0%, rgba(10,10,11,1) 100%);
      color: var(--cream);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -18px 0 44px rgba(0,0,0,.55);
      z-index: 9999;
      transform: translateX(102%);
      transition: transform .22s ease;
      display:flex;
      flex-direction: column;
      overflow: hidden;
    }
    .ioi-panel.open{ transform: translateX(0); }

    .ioi-panel header{
      padding: 18px 18px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .ioi-panel .ptitle{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .06em;
      text-transform: uppercase;
      margin: 0;
      color: #efece8;
    }
    .ioi-panel .psub{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(214,211,207,.78);
      line-height: 1.35;
    }

    .ioi-panel .close{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #f3f0ec;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing: .02em;
      min-height: 38px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .ioi-panel .close:hover{ background: rgba(255,255,255,.09); }
    .ioi-panel .close:active{ transform: translateY(1px); }

    .ioi-panel .body{
      padding: 14px 18px 18px;
      overflow:auto;
    }

    .ioi-note{
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      margin-bottom: 14px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.92);
    }
    .ioi-note strong{ color: #fff; }
    .bad{ color: var(--bad); } /* was referenced in your text but missing in original */

    .ioi-metric{
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.08);
      padding: 14px 14px 12px;
      margin-bottom: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }

    .ioi-metric h4{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #f1efec;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .ioi-tag{
      font-size: 11px;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(241,239,236,.92);
      letter-spacing: .02em;
      text-transform:none;
    }
    .ioi-tag.good{ color: var(--ok); background: rgba(32,201,151,.12); border-color: rgba(32,201,151,.22); }
    .ioi-tag.bad { color: var(--bad); background: rgba(255,92,92,.12); border-color: rgba(255,92,92,.22); }
    .ioi-tag.neutral{ color:#c7c4bf; background: rgba(199,196,191,.10); border-color: rgba(199,196,191,.18); }

    .ioi-lines{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 12px;
      line-height: 1.45;
      color: rgba(241,239,236,.90);
    }
    .ioi-lines .k{
      color: rgba(214,211,207,.82);
      font-weight: 800;
      letter-spacing: .02em;
    }
    .ioi-lines code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 10px;
      color: rgba(241,239,236,.92);
      white-space: nowrap;
    }

    .ioi-gates{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
      padding-top: 10px;
      display:grid;
      gap: 6px;
      font-size: 12px;
      color: rgba(241,239,236,.90);
    }
    .ioi-gates .gate{
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }
    .ioi-gates .b{
      font-weight: 900;
      letter-spacing: .02em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      min-width: 76px;
      text-align:center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .ioi-gates .b.warn{ color: var(--warn); background: rgba(246,193,70,.12); border-color: rgba(246,193,70,.24); }
    .ioi-gates .b.alert{ color: #ffb3b3; background: rgba(255,92,92,.14); border-color: rgba(255,92,92,.26); }

    @media (max-width: 520px){
      .ioi-title{ align-items:flex-start; }
      .ioi-actions{ width: 100%; justify-content: flex-start; }
    }

    /* ---------- Section cards ---------- */
    .section{
      background: var(--cream);
      color: var(--onyx);
      border-radius: var(--radius-lg);
      padding: 26px;
      margin-bottom: 34px;
      box-shadow: var(--card-shadow);
    }

    .section h2{
      margin:0 0 6px;
      font-size: 20px;
      color: var(--onyx);
    }

    .section p{
      margin:0 0 18px;
      font-size: 13px;
      color: #444;
    }

    /* ---------- Form row / controls ---------- */
    .row{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .small{ font-size: 12px; color: #555; }
    label.small{ font-weight: 600; color: #333; }

    .input, input, select{
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #111;
      outline: none;
      min-height: 40px;
    }

    input.input{ flex: 1 1 320px; }
    select{ min-width: 160px; }

    button, .btn{
      font-family: inherit;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: #111;
      color: #fff;
      cursor: pointer;
      min-height: 40px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    button:hover, .btn:hover{ filter: brightness(1.05); }
    button:active, .btn:active{ transform: translateY(1px); }

    /* ---------- Panels ---------- */
    .panel{
      background: #f7f5f2;
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--soft-shadow);
      border: 1px solid rgba(0,0,0,.06);
    }

    .panel-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title{
      font-weight: 800;
      letter-spacing: -.01em;
      color: #111;
    }

    .hint{
      font-size: 12px;
      color: #666;
      margin-top: 3px;
    }

    /* ---------- Key/Value grid ---------- */
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      margin-top: 12px;
      font-size: 13px;
    }
    .kv .k{ color: #444; }
    .kv .v{
      font-weight: 700;
      color: #111;
      text-align:right;
      white-space: nowrap;
    }

    /* ---------- Subcontractor Cards Grid ---------- */
    .grid-3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid-3{ grid-template-columns: 1fr; }
    }

    .card{
      background: #f5f3f0;
      border-radius: var(--radius-md);
      padding: 18px;
      box-shadow: var(--soft-shadow);
      transition: transform .25s ease, box-shadow .25s ease;
      border: 1px solid rgba(0,0,0,.05);
    }

    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 22px 50px rgba(0,0,0,.25);
    }

    .card h3{
      margin:0 0 6px;
      font-size: 16px;
      color: var(--onyx);
    }

    .meta{
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    .card.clickable{ cursor: pointer; }
    .card.active{
      box-shadow:
        0 0 0 2px var(--burgundy),
        0 22px 50px rgba(0,0,0,.28);
    }

    /* ---------- Incidents ---------- */
    .inc-list{ margin-top: 10px; }

    .inc-row{
      display:grid;
      grid-template-columns: 1fr 1.2fr auto;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,.10);
      align-items:center;
    }
    @media (max-width: 760px){
      .inc-row{ grid-template-columns: 1fr; }
    }

    .link{
      color: var(--burgundy);
      font-weight: 700;
      text-decoration: none;
    }
    .link:hover{ text-decoration: underline; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      margin-left: 8px;
      vertical-align: middle;
    }
    .pill.high{ background:#f8d7da; color:#842029; }
    .pill.mod { background:#fff3cd; color:#856404; }
    .pill.low { background:#e7f5ec; color:#146c43; }

    /* ---------- Status ---------- */
    .status{
      margin-top: 14px;
      font-size: 12px;
      color: #6b6b6b;
    }
    .status.danger{
      color: #b42318;
      font-weight: 800;
    }

    /* ---------- Top status (dark context) ---------- */
    .status-top{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(214,211,207,.72);
      min-height: 16px;
    }
    .status-top.danger{
      color: #ffb3b3;
      font-weight: 900;
    }
  </style>
</head>

<body>
  <header class="brand-header">
    <img src="coopersteel-logo.png" alt="Cooper Steel" class="brand-logo">
  </header>

  <div class="shell">
    <div class="container">
      <h1>2026 Safety Performance</h1>
      <div class="subhead">
        <div>Real-time safety metrics across all active projects and subcontractors.</div>
        <div class="updated" id="lastUpdated">
          <span class="dot-live" aria-hidden="true"></span>
          <span>Last updated: <span id="lastUpdatedText">—</span></span>
        </div>
      </div>

      <div class="kpi-row" id="kpis" aria-live="polite">
        <div class="kpi"><div class="val skeleton skel"></div><div class="lab">Total Man-Hours</div></div>
        <div class="kpi"><div class="val skeleton skel"></div><div class="lab">TRIR</div></div>
        <div class="kpi"><div class="val skeleton skel"></div><div class="lab">LTIR</div></div>
        <div class="kpi"><div class="val skeleton skel"></div><div class="lab">Total Recordables</div></div>
        <div class="kpi"><div class="val skeleton skel"></div><div class="lab">Active Subcontractors</div></div>
      </div>

      <!-- IOI TICKER -->
      <div class="ioi-wrap">
        <div class="ioi-title">
          <h3>Intelligent Operational Indicators</h3>
          <div class="ioi-actions">
            <div class="ioi-sub">Rolling 30-day signal • Hover to pause</div>
            <button class="ioi-info-btn" id="ioiExplainBtn" type="button" aria-haspopup="dialog" aria-controls="ioiPanel">
              <span class="dot">i</span> What's this?
            </button>
          </div>
        </div>

        <div class="ticker" id="ioiTicker">
          <div class="ticker-track" id="tickerTrack" aria-label="Intelligent Operational Indicators ticker"></div>
        </div>

        <div class="status-top" id="ioiStatus"></div>
      </div>

      <!-- IOI EXPLAINER (single instance, no duplicate IDs) -->
      <div class="ioi-backdrop" id="ioiBackdrop" aria-hidden="true"></div>
      <div class="ioi-panel" id="ioiPanel" role="dialog" aria-modal="true" aria-labelledby="ioiPanelTitle" aria-hidden="true">
        <header>
          <div style="min-width:0;">
            <div class="ptitle" id="ioiPanelTitle">Intelligent Operational Indicators</div>
            <div class="psub">
              Definitions for the ticker above. These are <strong>rolling 30-day</strong> signals meant to highlight
              where attention should go <em>before</em> a serious event happens.
            </div>
          </div>
          <button class="close" id="ioiCloseBtn" type="button" aria-label="Close IOI explainer">Close</button>
        </header>

        <div class="body">
          <div class="ioi-note">
            <strong>How to read the ticker:</strong> The first number is the current 30-day value. The second number (▲/▼) is the change versus the prior 30-day window.
            <br><br>
            <strong>Important:</strong> “Up” is not always good. Some indicators rising is <strong class="bad">worse</strong> (risk increasing).
            This panel tells you which direction is good/bad for each indicator.
          </div>

          <div class="ioi-metric">
            <h4>EWIR (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> An exposure-weighted incident rate for the last 30 days. Think: “How much stuff is happening, adjusted for hours worked.”</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> computed from <code>PUB_RECENT_INCIDENTS</code> + hours exposure (from <code>PUB_KPI</code>/<code>PUB_SUBS</code>).</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D EWIR. Delta = how much that EWIR moved compared to the previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>EWIR increases for 2 consecutive refresh cycles (trend), even if the number is “small.”</div>
              <div class="gate"><span class="b alert">Escalate</span>Large positive delta (sharp jump), or EWIR stays elevated > 30 days.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>RISK CONC (30D) <span class="ioi-tag bad">Up = Bad</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> Risk concentration—how clustered incidents are. Higher = problems are piling up in fewer places (one sub/site dragging the system).</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> derived from incident distribution in <code>PUB_RECENT_INCIDENTS</code> (by sub/project) and exposure.</div>
              <div><span class="k">Value vs Delta:</span> Value = current 30D concentration. Delta = movement vs previous 30D period.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Positive delta + the same sub/project repeatedly appearing in incidents.</div>
              <div class="gate"><span class="b alert">Escalate</span>Concentration rising while total volume is flat (means the risk is “sticking” to one area).</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>MOMENTUM (30D) <span class="ioi-tag neutral">Context</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> A direction-of-travel signal. It summarizes whether the overall 30-day risk picture is improving or worsening.</div>
              <div><span class="k">Data origin:</span> <code>PUB_IOI</code> (a blended signal from incidents, severity mix, and exposure patterns).</div>
              <div><span class="k">Value vs Delta:</span> Value = current momentum score. Delta = how the momentum shifted versus the prior 30D.</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>Momentum rising at the same time EWIR or Risk Concentration rises.</div>
              <div class="gate"><span class="b alert">Escalate</span>Momentum shows a sharp increase (big delta) even if recordables haven’t moved yet.</div>
            </div>
          </div>

          <div class="ioi-metric">
            <h4>TOP RISK SUB (≥10,000H) <span class="ioi-tag bad">Flag</span></h4>
            <div class="ioi-lines">
              <div><span class="k">What it means:</span> The subcontractor with the highest risk signal—only among subs with meaningful exposure (≥10,000 hours).</div>
              <div><span class="k">Data origin:</span> Name is surfaced in <code>PUB_IOI</code>, typically based on risk weighting from <code>PUB_SUBS</code> + <code>PUB_RECENT_INCIDENTS</code>.</div>
              <div><span class="k">Value vs Delta:</span> Value = the subcontractor name. No delta (it’s a label, not a rate).</div>
            </div>
            <div class="ioi-gates">
              <div class="gate"><span class="b warn">Investigate</span>If the same sub repeats week over week: do a focused field verification + coaching.</div>
              <div class="gate"><span class="b alert">Escalate</span>If that sub also shows rising EWIR / concentration: immediate plan, accountability, and increased oversight.</div>
            </div>
          </div>

          <div class="ioi-note">
            <strong>Quick “good vs bad” cheat sheet:</strong><br>
            • <strong class="bad">EWIR up</strong> = risk rising (bad).<br>
            • <strong class="bad">Risk Concentration up</strong> = risk clustering (bad).<br>
            • <strong>MOMENTUM</strong> = interpret with the other signals (context).<br>
            • <strong>Top Risk Sub</strong> = where to look first.
          </div>
        </div>
      </div>

      <div class="section" id="subsSection">
        <h2>Subcontractor Performance</h2>
        <p>Top subcontractors by hours are shown below. Use the lookup to view any subcontractor.</p>

        <div class="row">
          <label class="small" for="subPick">Subcontractor</label>
          <input class="input" id="subPick" list="subList" placeholder="Type a subcontractor name…" autocomplete="off" />
          <datalist id="subList"></datalist>
        </div>

        <div class="panel" id="subDetail" style="margin-top:12px;">
          <div class="title">Loading subcontractors…</div>
          <div class="hint">Please wait.</div>
          <div class="small">—</div>
        </div>

        <div style="height:16px"></div>
        <div class="grid-3" id="subCards"></div>
        <div class="status" id="subHint"></div>

        <div class="panel" id="subIncPanel" style="display:none; margin-top:14px;">
          <div class="panel-head">
            <div>
              <div class="title" id="subIncTitle">Incidents —</div>
              <div class="hint" id="subIncHint">Showing incidents for selected subcontractor.</div>
            </div>
            <button class="btn" id="subIncClose" type="button">Close</button>
          </div>
          <div id="subIncList"></div>
        </div>
      </div>

      <div class="section" id="incSection">
        <h2>Incidents</h2>
        <p>Latest incidents shown. Search by subcontractor, project, or incident ID.</p>

        <div class="row">
          <input class="input" id="q" placeholder="Search incidents (sub, project, ID)" autocomplete="off" />
          <select id="sev">
            <option value="">Severity: All</option>
            <option value="High">High</option>
            <option value="Moderate">Moderate</option>
            <option value="Low">Low</option>
          </select>
          <button id="clear" type="button">Clear</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="small" for="incPick">Incident</label>
          <input class="input" id="incPick" list="incList" placeholder="Type an Incident ID…" autocomplete="off" />
          <datalist id="incList"></datalist>
        </div>

        <div class="panel" id="incDetail" style="margin-top:12px;">
          <div class="title">Loading incidents…</div>
          <div class="hint">Please wait.</div>
          <div class="small">—</div>
        </div>

        <div class="inc-list" id="incidentList"></div>
        <div class="status" id="incHint"></div>

        <div style="margin-top:12px" class="small">
          Click “View report” to see the incident report details.
        </div>
      </div>

      <div class="status-top" id="topStatus" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /******************************************************************
     * CONFIG
     ******************************************************************/
    const CONFIG = {
      // Your published CSV URLs:
      KPI_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=152373673&single=true&output=csv",
      SUBS_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=466735545&single=true&output=csv",
      INCIDENTS_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=1844704592&single=true&output=csv",
      IOI_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=303885721&single=true&output=csv",

      // Refresh controls:
      AUTO_REFRESH_MS: 5 * 60 * 1000, // 5 minutes
      IOI_REFRESH_MS: 2 * 60 * 1000,  // IOI can refresh more often if desired

      // UI controls:
      TOP_SUBS_COUNT: 9,
      SUB_INCIDENT_CAP: 25,
      INCIDENTS_CAP_DEFAULT: 5,
      INCIDENTS_CAP_FILTERED: 10,

      // Ticker:
      TICKER_PX_PER_SEC: 55, // speed (px/sec)
    };

    /******************************************************************
     * Tiny helpers
     ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function setTopStatus(msg, isErr=false){
      const el = $("topStatus");
      el.textContent = msg || "";
      el.className = "status-top" + (isErr ? " danger" : "");
    }

    function setIOIStatus(msg, isErr=false){
      const el = $("ioiStatus");
      el.textContent = msg || "";
      el.className = "status-top" + (isErr ? " danger" : "");
    }

    function setLastUpdated(ts = new Date()){
      $("lastUpdatedText").textContent = ts.toLocaleString(undefined, {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    }

    function toNumber(x){
      if (x === null || x === undefined) return 0;
      const n = parseFloat(String(x).replace(/,/g,"").trim());
      return Number.isFinite(n) ? n : 0;
    }

    function safeText(x){
      return (x === null || x === undefined) ? "" : String(x);
    }

    function fmtNum(n, digits=2){
      const v = parseFloat(n);
      if (!Number.isFinite(v)) return safeText(n) || "—";
      return v.toFixed(digits);
    }

    function safeUrlMaybe(url){
      const raw = safeText(url).trim();
      if (!raw) return "";
      try{
        const u = new URL(raw, window.location.href);
        if (u.protocol === "http:" || u.protocol === "https:") return u.href;
        return "";
      }catch{
        return "";
      }
    }

    function parseDateLoose(s){
      const str = safeText(s).trim();
      if (!str) return 0;
      const t = Date.parse(str);
      if (Number.isFinite(t)) return t;

      // fallback attempt for common mm/dd/yyyy
      const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (m){
        const mm = Number(m[1]) - 1;
        const dd = Number(m[2]);
        const yy = Number(m[3].length === 2 ? ("20" + m[3]) : m[3]);
        const d = new Date(yy, mm, dd);
        return d.getTime();
      }
      return 0;
    }

    /******************************************************************
     * CSV parsing + Data service
     ******************************************************************/
    const bust = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const next = text[i+1];

        if (c === '"'){
          if (inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && c === ","){
          row.push(cur); cur = ""; continue;
        }
        if (!inQuotes && (c === "\n" || c === "\r")){
          if (c === "\r" && next === "\n") i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }
        cur += c;
      }
      row.push(cur);
      rows.push(row);
      return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
    }

    async function fetchTable(url){
      const res = await fetch(bust(url), { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed: " + res.status);
      const txt = await res.text();
      const grid = parseCSV(txt);
      if (!grid.length) return [];

      const headers = grid[0].map(h => String(h).trim());
      const out = [];

      for (let i=1; i<grid.length; i++){
        const obj = {};
        for (let j=0; j<headers.length; j++){
          const key = headers[j] || ("col"+j);
          obj[key] = (grid[i][j] ?? "").trim();
        }
        out.push(obj);
      }
      return out;
    }

    /******************************************************************
     * DOM-safe element builders (avoid innerHTML for CSV content)
     ******************************************************************/
    function el(tag, attrs = {}, children = []){
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === "class") node.className = v;
        else if (k === "text") node.textContent = v;
        else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
        else node.setAttribute(k, String(v));
      }
      for (const c of children){
        if (c === null || c === undefined) continue;
        node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      }
      return node;
    }

    function clearNode(node){
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    /******************************************************************
     * KPI rendering
     ******************************************************************/
    function renderKPIs(kpis){
      const map = {};
      for (const r of kpis) map[r.Metric] = r.Value;

      const totalHours = safeText(map["Total Man-Hours"] ?? "—");
      const trir = safeText(map["TRIR"] ?? "—");
      const ltir = safeText(map["LTIR"] ?? "—");
      const rec = safeText(map["Total Recordables"] ?? "—");
      const active = safeText(map["Active Subcontractors"] ?? "—");

      const kpiEls = $("kpis").querySelectorAll(".kpi .val");
      const vals = [totalHours, trir, ltir, rec, active];

      vals.forEach((v, i) => {
        const cell = kpiEls[i];
        cell.classList.remove("skeleton", "skel");
        cell.textContent = v;
      });
    }

    /******************************************************************
     * IOI ticker (JS-driven for seamless loop + pause)
     ******************************************************************/
    const Ticker = (() => {
      let raf = 0;
      let lastTs = 0;
      let x = 0;
      let paused = false;

      function buildTick(label, value, delta){
        const d = parseFloat(delta);
        let cls = "flat", arrow = "•", sign = "";
        if (Number.isFinite(d)){
          if (d > 0){ cls = "up"; arrow = "▲"; sign = "+"; }
          else if (d < 0){ cls = "down"; arrow = "▼"; sign = ""; }
        }
        const deltaTxt = Number.isFinite(d) ? `${arrow} ${sign}${fmtNum(d, 2)}` : "• —";

        const root = el("div", { class: "tick" }, [
          el("span", { class: "sym", text: label }),
          el("span", { class: "val", text: value }),
          el("span", { class: "chg " + cls, text: deltaTxt })
        ]);
        return root;
      }

      function buildStaticTick(label, value){
        return el("div", { class: "tick" }, [
          el("span", { class: "sym", text: label }),
          el("span", { class: "val", text: value || "—" }),
          el("span", { class: "chg flat", text: "•" })
        ]);
      }

      function render(ioiRow){
        const track = $("tickerTrack");
        clearNode(track);

        if (!ioiRow){
          track.appendChild(buildStaticTick("IOI", "No data"));
          track.appendChild(buildStaticTick("IOI", "No data")); // duplicate for loop
          return;
        }

        const ewir = safeText(ioiRow.EWIR_30 || "");
        const ewirD = safeText(ioiRow.EWIR_DELTA || "");

        const rc = safeText(ioiRow.RISK_CONC_30 || "");
        const rcD = safeText(ioiRow.RISK_CONC_DELTA || "");

        const mom = safeText(ioiRow.MOMENTUM_30 || "");
        const momD = safeText(ioiRow.MOMENTUM_DELTA || "");

        const top = safeText(ioiRow.TOP_RISK_SUB_30 || "");

        const items = [
          buildTick("EWIR (30D)", fmtNum(ewir,2), ewirD),
          buildTick("RISK CONC (30D)", fmtNum(rc,4), rcD),
          buildTick("MOMENTUM (30D)", fmtNum(mom,2), momD),
          buildStaticTick("TOP RISK SUB (≥10,000H)", top || "—"),
        ];

        // Duplicate for infinite loop
        for (const node of items) track.appendChild(node);
        for (const node of items.map(n => n.cloneNode(true))) track.appendChild(node);

        // Reset animation position
        x = 0;
        track.style.transform = "translateX(0px)";
      }

      function start(){
        stop();
        const prefersReduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (prefersReduce) return;

        const track = $("tickerTrack");
        const wrap = $("ioiTicker");
        if (!track || !wrap) return;

        wrap.addEventListener("mouseenter", () => paused = true);
        wrap.addEventListener("mouseleave", () => paused = false);

        const step = (ts) => {
          if (!lastTs) lastTs = ts;
          const dt = (ts - lastTs) / 1000;
          lastTs = ts;

          if (!paused){
            const speed = CONFIG.TICKER_PX_PER_SEC;
            x -= speed * dt;

            // Loop logic:
            // When we've shifted beyond the width of the first half, wrap.
            const totalW = track.scrollWidth;
            const halfW = totalW / 2;

            if (Number.isFinite(halfW) && halfW > 0){
              if (-x >= halfW) x += halfW;
            }

            track.style.transform = `translateX(${x}px)`;
          }

          raf = requestAnimationFrame(step);
        };

        raf = requestAnimationFrame(step);
      }

      function stop(){
        if (raf) cancelAnimationFrame(raf);
        raf = 0;
        lastTs = 0;
      }

      return { render, start, stop };
    })();

    async function loadIOI(){
      try{
        setIOIStatus("Loading IOI…");
        const rows = await fetchTable(CONFIG.IOI_CSV);
        Ticker.render(rows[0] || null);
        Ticker.start();
        setIOIStatus("");
      }catch (e){
        console.error(e);
        Ticker.render(null);
        setIOIStatus("IOI failed to load. Check PUB_IOI publish link.", true);
      }
    }

    /******************************************************************
     * IOI Panel (A11y improved: focus trap + restore focus)
     ******************************************************************/
    const IOIPanel = (() => {
      let lastFocus = null;

      function focusables(container){
        return [...container.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )].filter(el => !el.hasAttribute("disabled") && !el.getAttribute("aria-hidden"));
      }

      function open(){
        const panel = $("ioiPanel");
        const back = $("ioiBackdrop");
        if (!panel || !back) return;

        lastFocus = document.activeElement;

        panel.classList.add("open");
        back.classList.add("open");
        panel.setAttribute("aria-hidden", "false");
        back.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        const btn = $("ioiCloseBtn");
        if (btn) btn.focus();
      }

      function close(){
        const panel = $("ioiPanel");
        const back = $("ioiBackdrop");
        if (!panel || !back) return;

        panel.classList.remove("open");
        back.classList.remove("open");
        panel.setAttribute("aria-hidden", "true");
        back.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";

        if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
        else $("ioiExplainBtn")?.focus();
      }

      function toggle(){
        const panel = $("ioiPanel");
        if (!panel) return;
        panel.classList.contains("open") ? close() : open();
      }

      function wire(){
        $("ioiExplainBtn")?.addEventListener("click", toggle);
        $("ioiCloseBtn")?.addEventListener("click", close);
        $("ioiBackdrop")?.addEventListener("click", close);

        document.addEventListener("keydown", (e) => {
          const panel = $("ioiPanel");
          if (!panel || !panel.classList.contains("open")) return;

          if (e.key === "Escape"){
            e.preventDefault();
            close();
            return;
          }

          if (e.key === "Tab"){
            const f = focusables(panel);
            if (!f.length) return;

            const first = f[0];
            const last = f[f.length - 1];
            const active = document.activeElement;

            if (e.shiftKey && active === first){
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && active === last){
              e.preventDefault();
              first.focus();
            }
          }
        });
      }

      return { wire, open, close, toggle };
    })();

    /******************************************************************
     * Subcontractors
     ******************************************************************/
    let SUBS_ALL = [];
    let INC_ALL = [];
    let ACTIVE_SUB = "";

    function normalizeSubsRows(rows){
      return rows.map(r => {
        const sub = r.Subcontractor || r.subcontractor || r.Sub || r.SUB || r.Name || r.name || "";
        const hours = toNumber(r.TotalHours ?? r.Hours ?? r.hours ?? 0);
        const incidents = toNumber(r.TotalIncidents ?? r.Incidents ?? r.incidents ?? 0);
        const recordables = toNumber(r.Recordables ?? r.recordables ?? 0);
        const lost = toNumber(r.LostTime ?? r.Lost ?? r.losttime ?? 0);
        const trir = safeText(r.TRIR ?? r.trir ?? "");
        const ltir = safeText(r.LTIR ?? r.ltir ?? "");
        return {
          sub: String(sub).trim(),
          hours,
          incidents,
          recordables,
          lost,
          trir: trir === "" ? "" : String(trir),
          ltir: ltir === "" ? "" : String(ltir)
        };
      }).filter(x => x.sub && x.sub.toLowerCase() !== "subcontractor");
    }

    function renderSubDetail(item){
      const box = $("subDetail");
      clearNode(box);

      if (!item){
        box.appendChild(el("div", { class: "title", text: "Select a subcontractor" }));
        box.appendChild(el("div", { class: "hint", text: "Details will appear here." }));
        box.appendChild(el("div", { class: "small", text: "No selection." }));
        return;
      }

      box.appendChild(el("div", { class: "title", text: item.sub }));
      box.appendChild(el("div", { class: "hint", text: "YTD exposure & rates" }));

      const kv = el("div", { class: "kv" }, [
        el("div", { class: "k", text: "Hours" }), el("div", { class: "v", text: item.hours.toLocaleString() }),
        el("div", { class: "k", text: "Incidents" }), el("div", { class: "v", text: String(item.incidents) }),
        el("div", { class: "k", text: "Recordables" }), el("div", { class: "v", text: String(item.recordables) }),
        el("div", { class: "k", text: "Lost Time" }), el("div", { class: "v", text: String(item.lost) }),
        el("div", { class: "k", text: "TRIR" }), el("div", { class: "v", text: item.trir || "0" }),
        el("div", { class: "k", text: "LTIR" }), el("div", { class: "v", text: item.ltir || "0" }),
      ]);
      box.appendChild(kv);
    }

    function setActiveSubCard(sub){
      ACTIVE_SUB = sub || "";
      document.querySelectorAll("#subCards .card.clickable").forEach(elm => {
        if ((elm.dataset.sub || "") === ACTIVE_SUB) elm.classList.add("active");
        else elm.classList.remove("active");
      });
    }

    function pillForSeverity(sev){
      const s = (sev || "").toLowerCase();
      if (s === "high") return { cls: "pill high", text: "High" };
      if (s === "moderate") return { cls: "pill mod", text: "Moderate" };
      if (s === "low") return { cls: "pill low", text: "Low" };
      return null;
    }

    function normalizeIncidentRows(rows){
      return rows.map(r => ({
        Date: r.Date || r.date || "",
        IncidentID: r.IncidentID || r.IncidentId || r.ID || r.Id || "",
        Subcontractor: r.Subcontractor || r.subcontractor || r.Sub || "",
        Project: r.Project || r.project || "",
        Severity: r.Severity || r.severity || "",
        ReportLink: safeUrlMaybe(r.ReportLink || r.reportlink || r.Link || "")
      })).filter(x => x.IncidentID && String(x.IncidentID).trim().toLowerCase() !== "incidentid");
    }

    function renderSubs(rows){
      SUBS_ALL = normalizeSubsRows(rows);

      const dl = $("subList");
      clearNode(dl);
      [...SUBS_ALL].sort((a,b) => a.sub.localeCompare(b.sub)).forEach(r => {
        dl.appendChild(el("option", { value: r.sub }));
      });

      const top = [...SUBS_ALL].sort((a,b)=> b.hours - a.hours).slice(0, CONFIG.TOP_SUBS_COUNT);

      const wrap = $("subCards");
      clearNode(wrap);

      top.forEach(r => {
        const card = el("div", { class: "card clickable" });
        card.dataset.sub = r.sub;

        card.appendChild(el("h3", { text: r.sub }));
        card.appendChild(el("div", { class: "meta", text: "YTD exposure & rates" }));

        const kv = el("div", { class: "kv" }, [
          el("div", { class: "k", text: "Hours" }), el("div", { class: "v", text: r.hours.toLocaleString() }),
          el("div", { class: "k", text: "Incidents" }), el("div", { class: "v", text: String(r.incidents) }),
          el("div", { class: "k", text: "Recordables" }), el("div", { class: "v", text: String(r.recordables) }),
          el("div", { class: "k", text: "TRIR" }), el("div", { class: "v", text: r.trir || "0" }),
          el("div", { class: "k", text: "LTIR" }), el("div", { class: "v", text: r.ltir || "0" }),
        ]);
        card.appendChild(kv);

        card.addEventListener("click", () => {
          setActiveSubCard(r.sub);
          openSubIncidentsPanel(r.sub);
        });

        wrap.appendChild(card);
      });

      $("subHint").textContent = `Showing top ${top.length} by hours. Use lookup to view any of ${SUBS_ALL.length} subcontractors.`;

      // Wire lookup
      const pick = $("subPick");
      const apply = () => {
        const v = (pick.value || "").trim().toLowerCase();
        const found = SUBS_ALL.find(x => x.sub.toLowerCase() === v);
        renderSubDetail(found || null);
      };
      pick.onchange = apply;
      pick.onblur = apply;
      pick.onkeydown = (e) => { if (e.key === "Enter") apply(); };

      // Default detail
      renderSubDetail(null);
    }

    function openSubIncidentsPanel(sub){
      const panel = $("subIncPanel");
      const title = $("subIncTitle");
      const hint = $("subIncHint");
      const list = $("subIncList");

      const s = (sub || "").trim();
      title.textContent = s ? `Incidents — ${s}` : "Incidents —";
      panel.style.display = "block";

      const rows = [...INC_ALL]
        .filter(r => safeText(r.Subcontractor).trim().toLowerCase() === s.toLowerCase())
        .sort((a,b)=> (parseDateLoose(b.Date) - parseDateLoose(a.Date)));

      hint.textContent = rows.length ? `${rows.length} incident(s) found.` : "No incidents found for this subcontractor.";

      clearNode(list);

      if (!rows.length){
        list.appendChild(el("div", { class: "small", text: "No incidents match." }));
        return;
      }

      const cap = CONFIG.SUB_INCIDENT_CAP;
      const shown = rows.slice(0, cap);

      shown.forEach(r => {
        const row = el("div", { class: "inc-row" });

        // col 1
        const c1 = el("div", {}, [
          el("strong", { text: safeText(r.Date) || "—" }),
          el("div", { class: "meta", text: safeText(r.IncidentID) || "—" })
        ]);

        // col 2
        const sev = pillForSeverity(r.Severity);
        const strong = el("strong", { text: safeText(r.Subcontractor) || "—" });
        if (sev){
          strong.appendChild(document.createTextNode(" "));
          strong.appendChild(el("span", { class: sev.cls, text: sev.text }));
        }
        const c2 = el("div", {}, [
          strong,
          el("div", { class: "meta", text: safeText(r.Project) || "" })
        ]);

        // col 3
        const c3 = el("div", { style: "text-align:right;" });
        if (r.ReportLink){
          c3.appendChild(el("a", { class: "link", href: r.ReportLink, target: "_blank", rel: "noopener", text: "View report" }));
        } else {
          c3.appendChild(el("span", { class: "small", text: "—" }));
        }

        row.appendChild(c1);
        row.appendChild(c2);
        row.appendChild(c3);

        list.appendChild(row);
      });

      if (rows.length > cap){
        list.appendChild(el("div", { class: "small", style: "padding-top:10px;", text: `Showing first ${cap}. Refine using the Incidents search below if needed.` }));
      }
    }

    /******************************************************************
     * Incidents list + detail + filters
     ******************************************************************/
    function renderIncidentDetail(item){
      const box = $("incDetail");
      clearNode(box);

      if (!item){
        box.appendChild(el("div", { class: "title", text: "Select an incident" }));
        box.appendChild(el("div", { class: "hint", text: "Details will appear here." }));
        box.appendChild(el("div", { class: "small", text: "No selection." }));
        return;
      }

      box.appendChild(el("div", { class: "title", text: safeText(item.IncidentID) || "—" }));
      box.appendChild(el("div", { class: "hint", text: `${safeText(item.Date) || ""} • ${safeText(item.Severity) || "—"} • ${safeText(item.Subcontractor) || "—"}` }));

      const kv = el("div", { class: "kv" }, [
        el("div", { class: "k", text: "Project" }), el("div", { class: "v", text: safeText(item.Project) || "—" }),
        el("div", { class: "k", text: "Subcontractor" }), el("div", { class: "v", text: safeText(item.Subcontractor) || "—" }),
        el("div", { class: "k", text: "Severity" }), el("div", { class: "v", text: safeText(item.Severity) || "—" }),
        el("div", { class: "k", text: "Date" }), el("div", { class: "v", text: safeText(item.Date) || "—" }),
      ]);
      box.appendChild(kv);

      const footer = el("div", { style: "margin-top:12px;" });
      if (item.ReportLink){
        footer.appendChild(el("a", { class: "link", href: item.ReportLink, target: "_blank", rel: "noopener", text: "View report" }));
      } else {
        footer.appendChild(el("span", { class: "small", text: "No report link" }));
      }
      box.appendChild(footer);
    }

    function renderIncidentsLookup(){
      const dl = $("incList");
      clearNode(dl);
      [...INC_ALL].sort((a,b)=> String(a.IncidentID).localeCompare(String(b.IncidentID))).forEach(r => {
        dl.appendChild(el("option", { value: safeText(r.IncidentID) }));
      });

      const pick = $("incPick");
      const apply = () => {
        const v = (pick.value || "").trim().toLowerCase();
        const found = INC_ALL.find(x => safeText(x.IncidentID).trim().toLowerCase() === v);
        renderIncidentDetail(found || null);
      };
      pick.onchange = apply;
      pick.onblur = apply;
      pick.onkeydown = (e) => { if (e.key === "Enter") apply(); };
    }

    function renderIncidentsTable(){
      const q = $("q").value.trim().toLowerCase();
      const sev = $("sev").value;

      let rows = [...INC_ALL];

      if (sev) rows = rows.filter(r => safeText(r.Severity) === sev);

      if (q){
        rows = rows.filter(r => (
          safeText(r.IncidentID).toLowerCase().includes(q) ||
          safeText(r.Subcontractor).toLowerCase().includes(q) ||
          safeText(r.Project).toLowerCase().includes(q)
        ));
      }

      rows.sort((a,b)=> parseDateLoose(b.Date) - parseDateLoose(a.Date));

      const cap = (q || sev) ? CONFIG.INCIDENTS_CAP_FILTERED : CONFIG.INCIDENTS_CAP_DEFAULT;
      const shown = rows.slice(0, cap);

      $("incHint").textContent = (q || sev)
        ? `Showing top ${Math.min(cap, rows.length)} matches (capped).`
        : `Showing latest ${CONFIG.INCIDENTS_CAP_DEFAULT} incidents.`;

      const list = $("incidentList");
      clearNode(list);

      if (!shown.length){
        list.appendChild(el("div", { class: "small", style: "padding:12px 0;", text: "No incidents match your filters." }));
        return;
      }

      shown.forEach(r => {
        const row = el("div", { class: "inc-row" });

        const c1 = el("div", {}, [
          el("strong", { text: safeText(r.Date) || "—" }),
          el("div", { class: "meta", text: safeText(r.IncidentID) || "—" })
        ]);

        const sevP = pillForSeverity(r.Severity);
        const strong = el("strong", { text: safeText(r.Subcontractor) || "—" });
        if (sevP){
          strong.appendChild(document.createTextNode(" "));
          strong.appendChild(el("span", { class: sevP.cls, text: sevP.text }));
        }
        const c2 = el("div", {}, [
          strong,
          el("div", { class: "meta", text: safeText(r.Project) || "" })
        ]);

        const c3 = el("div", { style: "text-align:right;" });
        if (r.ReportLink){
          c3.appendChild(el("a", { class: "link", href: r.ReportLink, target: "_blank", rel: "noopener", text: "View report" }));
        } else {
          c3.appendChild(el("span", { class: "small", text: "—" }));
        }

        row.appendChild(c1);
        row.appendChild(c2);
        row.appendChild(c3);

        list.appendChild(row);
      });
    }

    function autoSelectLatestIncident(){
      const latest = [...INC_ALL].sort((a,b)=> parseDateLoose(b.Date) - parseDateLoose(a.Date))[0];
      if (latest) renderIncidentDetail(latest);
      else renderIncidentDetail(null);
    }

    /******************************************************************
     * Load pipeline (section-level resilience)
     ******************************************************************/
    async function loadAll(){
      setTopStatus("Loading data…");
      try{
        const [kpis, subs, inc] = await Promise.all([
          fetchTable(CONFIG.KPI_CSV).catch(e => (console.error(e), null)),
          fetchTable(CONFIG.SUBS_CSV).catch(e => (console.error(e), null)),
          fetchTable(CONFIG.INCIDENTS_CSV).catch(e => (console.error(e), null)),
        ]);

        // KPI
        if (kpis) renderKPIs(kpis);
        else {
          setTopStatus("KPI failed to load. Check PUB_KPI publish link.", true);
          // remove skeleton but show fallback
          const kpiEls = $("kpis").querySelectorAll(".kpi .val");
          kpiEls.forEach(elm => { elm.classList.remove("skeleton","skel"); elm.textContent = "—"; });
        }

        // Subs
        if (subs){
          renderSubs(subs);
        } else {
          $("subDetail").innerHTML = '<div class="title">Subcontractors failed to load.</div><div class="hint">Check SUBS CSV publish link.</div><div class="small">—</div>';
          $("subHint").textContent = "Could not load subcontractor data.";
        }

        // Incidents
        if (inc){
          INC_ALL = normalizeIncidentRows(inc);
          renderIncidentsLookup();
          renderIncidentsTable();
          autoSelectLatestIncident();
        } else {
          $("incDetail").innerHTML = '<div class="title">Incidents failed to load.</div><div class="hint">Check INCIDENTS CSV publish link.</div><div class="small">—</div>';
          $("incHint").textContent = "Could not load incidents.";
        }

        setLastUpdated(new Date());
        setTopStatus("");
      }catch (err){
        console.error(err);
        setTopStatus("Data fetch failed. Check CSV publish links, then refresh.", true);
      }
    }

    /******************************************************************
     * Wiring + Auto refresh
     ******************************************************************/
    function wireUI(){
      // close sub incidents
      $("subIncClose").addEventListener("click", () => {
        $("subIncPanel").style.display = "none";
        setActiveSubCard("");
      });

      // incident filters
      $("q").addEventListener("input", renderIncidentsTable);
      $("sev").addEventListener("change", renderIncidentsTable);
      $("clear").addEventListener("click", () => {
        $("q").value = "";
        $("sev").value = "";
        renderIncidentsTable();
      });

      IOIPanel.wire();
    }

    function startRefreshLoops(){
      // Main refresh
      if (CONFIG.AUTO_REFRESH_MS > 0){
        setInterval(() => loadAll(), CONFIG.AUTO_REFRESH_MS);
      }
      // IOI refresh (separate, doesn't block)
      if (CONFIG.IOI_REFRESH_MS > 0){
        setInterval(() => loadIOI(), CONFIG.IOI_REFRESH_MS);
      }
    }

    /******************************************************************
     * INIT
     ******************************************************************/
    (async function init(){
      wireUI();
      await loadAll();
      await loadIOI();
      startRefreshLoops();
    })();
  </script>
</body>
</html>
