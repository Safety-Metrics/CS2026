<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Safety Performance</title>
  <style>
    :root{
      --cream:#F2EFEB;
      --cloud:#CFCDCA;
      --cooperred:#9F1C1F;
      --burgundy:#680C19;
      --onyx:#111112;
      --charcoal:#282828;
      --steel:#5D5C5A;

      --bg: var(--onyx);
      --panel: rgba(17,17,18,.72);
      --panel2: rgba(40,40,40,.55);
      --card: rgba(242,239,235,.96);
      --card2: rgba(242,239,235,.88);
      --text:#111112;
      --muted:#5D5C5A;
      --border: rgba(207,205,202,.45);
      --shadow: 0 12px 30px rgba(0,0,0,.22);
      --shadowSoft: 0 6px 18px rgba(0,0,0,.16);
      --radius: 14px;
      --radiusSm: 10px;
      --max: 1100px;

      /* Optional: drop a background image into your repo (recommended) */
      --heroImage: url('bg.jpg');
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(159,28,31,.35), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(104,12,25,.28), transparent 55%),
        linear-gradient(180deg, rgba(17,17,18,.92), rgba(17,17,18,.92)),
        var(--heroImage);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .shell{
      max-width: var(--max);
      margin: 26px auto 40px;
      border-radius: 22px;
      border: 1px solid rgba(207,205,202,.18);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .container{
      padding: 34px 18px 74px;
    }
    h1{font-size:32px;margin:0 0 6px;letter-spacing:-.02em;color:var(--cream)}
    .subhead{color:rgba(242,239,235,.72);margin:0 0 18px;font-size:13px}
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 18px;
      margin: 18px 0 34px;
    }
    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      min-height: 76px;
    }
    .kpi .val{
      font-size: 26px;
      font-weight: 700;
      line-height: 1.05;
      letter-spacing:-.02em;
    }
    .kpi .lab{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .section{
      margin-top: 28px;
    }
    .section h2{ font-size: 18px; margin: 0 0 6px; letter-spacing:-.01em; color: var(--cream); }
    .section p{ margin: 0 0 14px; color: rgba(242,239,235,.70); font-size: 13px; }
    .row{
      display:flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items:center;
    }
    .input, select, button{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    .input{
      min-width: 280px;
    }
    button{
      cursor:pointer;
    }
    button:hover{ filter: brightness(.98); }

    .grid-3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      min-height: 140px;
    }
    .card h3{
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing:-.01em;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .kv{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      font-size: 12px;
    }
    .kv .k{ color: var(--muted); }
    .kv .v{ font-weight: 600; text-align:right; }

    .panel{
      margin-top: 14px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .panel .title{
      font-weight: 700;
      font-size: 14px;
      margin: 0 0 4px;
    }
    .panel .hint{
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 12px;
    }

    .inc-list{
      margin-top: 14px;
      border-top: 1px solid var(--border);
    }
    .inc-row{
      display:grid;
      grid-template-columns: 160px 1fr 120px;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      align-items:center;
    }
    .inc-row strong{
      display:block;
      font-size: 13px;
      margin-bottom: 2px;
    }
    .pill{
      display:inline-block;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      color: var(--muted);
      margin-left: 8px;
      vertical-align: middle;
    }
    .pill.high{ border-color:#fca5a5; color:#b91c1c; }
    .pill.mod{ border-color:#fde68a; color:#92400e; }
    .pill.low{ border-color:#bbf7d0; color:#166534; }
    a.link{
      color: #111827;
      text-decoration: underline;
      font-size: 12px;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }
    .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .danger{ color:#b91c1c; }
    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: 1fr 1fr; }
      .grid-3{ grid-template-columns: 1fr; }
      .inc-row{ grid-template-columns: 1fr; }
    }
  
    .card.clickable{ cursor:pointer; }
    .card.clickable:hover{ border-color:#cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .card.clickable.active{ outline:2px solid #111827; outline-offset: 0; }

    .panel-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background:#f9fafb;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
    }
    .btn:hover{ background:#f3f4f6; }

  
/* === Cooper-style theme overrides === */
:root{
      --cream:#F2EFEB;
      --cloud:#CFCDCA;
      --cooperred:#9F1C1F;
      --burgundy:#680C19;
      --onyx:#111112;
      --charcoal:#282828;
      --steel:#5D5C5A;

      --bg: var(--onyx);
      --panel: rgba(17,17,18,.72);
      --panel2: rgba(40,40,40,.55);
      --card: rgba(242,239,235,.96);
      --card2: rgba(242,239,235,.88);
      --text:#111112;
      --muted:#5D5C5A;
      --border: rgba(207,205,202,.45);
      --shadow: 0 12px 30px rgba(0,0,0,.22);
      --shadowSoft: 0 6px 18px rgba(0,0,0,.16);
      --radius: 14px;
      --radiusSm: 10px;
      --max: 1100px;

      /* Optional: drop a background image into your repo (recommended) */
      --heroImage: url('bg.jpg');
    }

body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(159,28,31,.35), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(104,12,25,.28), transparent 55%),
        linear-gradient(180deg, rgba(17,17,18,.92), rgba(17,17,18,.92)),
        var(--heroImage);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

.section{
  background: linear-gradient(180deg,#ffffff 0%, #fafafa 100%);
  border:1px solid var(--border);
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 2px 10px rgba(0,0,0,.06);
}

a.link{
  color: var(--steel-ink);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: color .15s ease, border-color .15s ease;
}
a.link:hover{
  color: var(--brand-red);
  border-color: var(--brand-red);
}

.input:focus, select:focus, button:focus{
  outline: none;
  border-color: var(--brand-red);
  box-shadow: 0 0 0 2px rgba(177,18,38,.15);
}

.card.clickable{
  cursor: pointer;
  position: relative;
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.card.clickable::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:3px;
  background: transparent;
  border-radius: 14px 0 0 14px;
  transition: background .15s ease;
}
.card.clickable:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(0,0,0,.08);
}
.card.clickable:hover::before,
.card.active::before{display:none!important;}
/* Subtle hover on buttons */
button:hover{ filter: brightness(.98); }

    /* Cooper-style accents */
    a, .link{ color: var(--cooperred); }
    a:hover, .link:hover{ color: #c02a2e; }

    .kpis{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: 14px; margin-top: 18px; }
    .kpi{
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      background: rgba(17,17,18,.22);
      border: 1px solid rgba(207,205,202,.18);
      box-shadow: var(--shadowSoft);
    }
    .kpi .v{ color: var(--cream); }
    .kpi .k{ color: rgba(242,239,235,.68); }

    .card{
      background: var(--card);
      border: 1px solid rgba(207,205,202,.45);
      border-radius: var(--radius);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .card:hover{
      border-color: rgba(159,28,31,.55);
      box-shadow: 0 14px 30px rgba(0,0,0,.14);
    }
    .card.active{
      
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      position: relative;
    }
    .card.active:before{display:none;}

    input, select{
      background: rgba(242,239,235,.98);
      border: 1px solid rgba(207,205,202,.75);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(159,28,31,.9);
      box-shadow: 0 0 0 3px rgba(159,28,31,.18);
    }

    button{
      cursor:pointer;
      border: 1px solid rgba(207,205,202,.70);
      border-radius: 10px;
      background: rgba(242,239,235,.96);
      padding: 9px 14px;
      font-size: 13px;
      color: var(--onyx);
    }
    button:hover{
      border-color: rgba(159,28,31,.75);
      box-shadow: 0 0 0 3px rgba(159,28,31,.12);
    }

    .pill{
      border-radius: 999px;
      border: 1px solid rgba(207,205,202,.75);
    }
    .pill.high{ border-color: rgba(159,28,31,.85); color: var(--cooperred); background: rgba(159,28,31,.10); }
    .pill.moderate{ border-color: rgba(104,12,25,.70); color: var(--burgundy); background: rgba(104,12,25,.10); }
    .pill.low{ border-color: rgba(93,92,90,.65); color: var(--steel); background: rgba(93,92,90,.10); }

    .divider{ border-top: 1px solid rgba(242,239,235,.16); margin: 26px 0; }

  

/* KPI text visibility */
.kpi{ color: rgba(242,239,235,.85) !important; }
.kpi .val{ color: var(--cream) !important; }
.kpi .label{ color: rgba(242,239,235,.70) !important; }


/* v4 fixes */
.panel h2{color: var(--onyx) !important;}
.panel p{color: rgba(17,17,18,.72) !important;}
.panel .hint, .panel .small{color: rgba(17,17,18,.62) !important;}
.card.active{outline:2px solid var(--burgundy) !important; box-shadow:0 10px 30px rgba(0,0,0,.18) !important;}
</style>
</head>
<body>
  <div class="shell"><div class="container">
    <h1>2026 Safety Performance</h1>
    <p class="subhead">Real-time safety metrics across all active projects and subcontractors.</p>

    <div class="kpi-row" id="kpis">
      <div class="kpi"><div class="val">—</div><div class="lab">Total Man-Hours</div></div>
      <div class="kpi"><div class="val">—</div><div class="lab">TRIR</div></div>
      <div class="kpi"><div class="val">—</div><div class="lab">LTIR</div></div>
      <div class="kpi"><div class="val">—</div><div class="lab">Total Recordables</div></div>
      <div class="kpi"><div class="val">—</div><div class="lab">Active Subcontractors</div></div>
    </div>

    <div class="section">
      <h2>Subcontractor Performance</h2>
      <p>Top subcontractors by hours are shown below. Use the lookup to view any subcontractor.</p>

      <div class="row">
        <label class="small" for="subPick">Subcontractor</label>
        <input class="input" id="subPick" list="subList" placeholder="Type a subcontractor name…" autocomplete="off" />
        <datalist id="subList"></datalist>
      </div>

      <div class="panel" id="subDetail">
        <div class="title">Select a subcontractor</div>
        <div class="hint">Details will appear here.</div>
        <div class="small">No selection.</div>
      </div>

      <div style="height:16px"></div>
      <div class="grid-3" id="subCards"></div>
      <div class="status" id="subHint"></div>
    
      <div class="panel" id="subIncPanel" style="display:none;">
        <div class="panel-head">
          <div>
            <div class="title" id="subIncTitle">Incidents —</div>
            <div class="hint" id="subIncHint">Showing incidents for selected subcontractor.</div>
          </div>
          <button class="btn" id="subIncClose" type="button">Close</button>
        </div>
        <div id="subIncList"></div>
      </div>
</div>

    <div class="section">
      <h2>Incidents</h2>
      <p>Latest incidents shown. Search by subcontractor, project, or incident ID.</p>

      <div class="row">
        <input class="input" id="q" placeholder="Search incidents (sub, project, ID)" autocomplete="off" />
        <select id="sev">
          <option value="">Severity: All</option>
          <option value="High">High</option>
          <option value="Moderate">Moderate</option>
          <option value="Low">Low</option>
        </select>
        <button id="clear">Clear</button>
      </div>

      <!-- Incident lookup + detail panel -->
      <div class="row" style="margin-top:10px;">
        <label class="small" for="incPick">Incident</label>
        <input class="input" id="incPick" list="incList" placeholder="Type an Incident ID…" autocomplete="off" />
        <datalist id="incList"></datalist>
      </div>

      <div class="panel" id="incDetail" style="margin-top:12px;">
        <div class="title">Select an incident</div>
        <div class="hint">Details will appear here.</div>
        <div class="small">No selection.</div>
      </div>

      <div class="inc-list" id="incidentList"></div>
      <div class="status" id="incHint"></div>

      <div style="margin-top:12px" class="small">
        Click “View report” to see the incident report details.
      </div>
    </div>

    <div class="status" id="status"></div>
  </div>

<script>
/*** CONFIG: your published CSV URLs ***/
const KPI_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=152373673&single=true&output=csv";
const SUBS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=466735545&single=true&output=csv";
const INCIDENTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrvHagkDQ72AeZe3sWPeJ_DJKgqL9Ipfw9WCdX0sAsRNxOhg_tJ9IhjkIo0Kij2vb4pBXqKyE6cCNJ/pub?gid=1844704592&single=true&output=csv";

/*** helpers ***/
const bust = (url) => url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();

function setStatus(msg, isErr=false){
  const el = document.getElementById("status");
  el.textContent = msg || "";
  el.className = "status" + (isErr ? " danger" : "");
}

function toNumber(x){
  if (x === null || x === undefined) return 0;
  const n = parseFloat(String(x).replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : 0;
}

function safeText(x){
  return (x === null || x === undefined) ? "" : String(x);
}

function parseCSV(text){
  // simple CSV parser w/ quoted fields support
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' ){
      if (inQuotes && next === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (!inQuotes && c === "," ){
      row.push(cur); cur = ""; continue;
    }
    if (!inQuotes && (c === "
" || c === "
")){
      if (c === "
" && next === "
") i++;
      row.push(cur); rows.push(row);
      row = []; cur = "";
      continue;
    }
    cur += c;
  }
  row.push(cur);
  rows.push(row);
  return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
}

async function fetchTable(url){
  const res = await fetch(bust(url), { cache: "no-store" });
  if (!res.ok) throw new Error("Fetch failed: " + res.status);
  const txt = await res.text();
  const grid = parseCSV(txt);

  if (!grid.length) return [];
  const headers = grid[0].map(h => String(h).trim());
  const out = [];

  for (let i=1; i<grid.length; i++){
    const obj = {};
    for (let j=0; j<headers.length; j++){
      obj[headers[j] || ("col"+j)] = (grid[i][j] ?? "").trim();
    }
    out.push(obj);
  }
  return out;
}

/*** KPI ***/
function renderKPIs(kpis){
  const map = {};
  kpis.forEach(r => { map[r.Metric] = r.Value; });

  const kpiEls = document.getElementById("kpis").querySelectorAll(".kpi .val");
  const totalHours = safeText(map["Total Man-Hours"] ?? "—");
  const trir = safeText(map["TRIR"] ?? "—");
  const ltir = safeText(map["LTIR"] ?? "—");
  const rec = safeText(map["Total Recordables"] ?? "—");
  const active = safeText(map["Active Subcontractors"] ?? "—");

  kpiEls[0].textContent = totalHours;
  kpiEls[1].textContent = trir;
  kpiEls[2].textContent = ltir;
  kpiEls[3].textContent = rec;
  kpiEls[4].textContent = active;
}

/*** SUBS ***/
let SUBS_ALL = [];

function normalizeSubsRows(rows){
  return rows.map(r => {
    const sub = r.Subcontractor || r.subcontractor || r.Sub || r.SUB || r.Name || r.name || "";
    const hours = toNumber(r.TotalHours ?? r.Hours ?? r.hours ?? 0);
    const incidents = toNumber(r.TotalIncidents ?? r.Incidents ?? r.incidents ?? 0);
    const recordables = toNumber(r.Recordables ?? r.recordables ?? 0);
    const lost = toNumber(r.LostTime ?? r.Lost ?? r.losttime ?? 0);
    const trir = safeText(r.TRIR ?? r.trir ?? "");
    const ltir = safeText(r.LTIR ?? r.ltir ?? "");
    return {
      sub: String(sub).trim(),
      hours,
      incidents,
      recordables,
      lost,
      trir: (trir === "" ? "" : String(trir)),
      ltir: (ltir === "" ? "" : String(ltir))
    };
  }).filter(x => x.sub && x.sub.toLowerCase() !== "subcontractor");
}

function renderSubDetail(item){
  const box = document.getElementById("subDetail");
  if (!item){
    box.innerHTML = `
      <div class="title">Select a subcontractor</div>
      <div class="hint">Details will appear here.</div>
      <div class="small">No selection.</div>
    `;
    return;
  }

  box.innerHTML = `
    <div class="title">${item.sub}</div>
    <div class="hint">YTD exposure & rates</div>
    <div class="kv">
      <div class="k">Hours</div><div class="v">${item.hours.toLocaleString()}</div>
      <div class="k">Incidents</div><div class="v">${item.incidents}</div>
      <div class="k">Recordables</div><div class="v">${item.recordables}</div>
      <div class="k">Lost Time</div><div class="v">${item.lost}</div>
      <div class="k">TRIR</div><div class="v">${item.trir || "0"}</div>
      <div class="k">LTIR</div><div class="v">${item.ltir || "0"}</div>
    </div>
  `;
}

function renderSubs(rows){
  SUBS_ALL = normalizeSubsRows(rows);

  const dl = document.getElementById("subList");
  dl.innerHTML = [...SUBS_ALL]
    .sort((a,b)=> a.sub.localeCompare(b.sub))
    .map(r => `<option value="${r.sub}"></option>`)
    .join("");

  const top = [...SUBS_ALL].sort((a,b)=> b.hours - a.hours).slice(0, 9);
  const wrap = document.getElementById("subCards");
  wrap.innerHTML = top.map(r => `
    <div class="card clickable" data-sub="${r.sub}">
      <h3>${r.sub}</h3>
      <div class="meta">YTD exposure & rates</div>
      <div class="kv">
        <div class="k">Hours</div><div class="v">${r.hours.toLocaleString()}</div>
        <div class="k">Incidents</div><div class="v">${r.incidents}</div>
        <div class="k">Recordables</div><div class="v">${r.recordables}</div>
        <div class="k">TRIR</div><div class="v">${r.trir || "0"}</div>
        <div class="k">LTIR</div><div class="v">${r.ltir || "0"}</div>
      </div>
    </div>
  `).join("");

  
  // Card drill-down (sub -> incidents)
  [...wrap.querySelectorAll(".card.clickable")].forEach(card=>{
    card.addEventListener("click", ()=>{
      const sub = card.dataset.sub || "";
      setActiveSubCard(sub);
      openSubIncidentsPanel(sub);
    });
  });
document.getElementById("subHint").textContent =
    `Showing top ${top.length} by hours. Use lookup to view any of ${SUBS_ALL.length} subcontractors.`;

  const pick = document.getElementById("subPick");
  if (!pick.dataset.wired){
    pick.dataset.wired = "1";
    const apply = () => {
      const v = (pick.value || "").trim().toLowerCase();
      const found = SUBS_ALL.find(x => x.sub.toLowerCase() === v);
      renderSubDetail(found || null);
    };
    pick.addEventListener("change", apply);
    pick.addEventListener("blur", apply);
    pick.addEventListener("keydown", (e)=>{ if (e.key === "Enter") apply(); });
  }
}

/*** INCIDENTS ***/
let INC_ALL = [];

let ACTIVE_SUB = "";

function setActiveSubCard(sub){
  ACTIVE_SUB = sub || "";
  document.querySelectorAll("#subCards .card.clickable").forEach(el=>{
    if ((el.dataset.sub || "") === ACTIVE_SUB) el.classList.add("active");
    else el.classList.remove("active");
  });
}

function openSubIncidentsPanel(sub){
  const panel = document.getElementById("subIncPanel");
  const title = document.getElementById("subIncTitle");
  const hint = document.getElementById("subIncHint");
  const list = document.getElementById("subIncList");

  const s = (sub || "").trim();
  title.textContent = s ? `Incidents — ${s}` : "Incidents —";
  panel.style.display = "block";

  const rows = [...INC_ALL]
    .filter(r => String(r.Subcontractor || "").trim().toLowerCase() === s.toLowerCase())
    .sort((a,b)=> String(b.Date||"").localeCompare(String(a.Date||"")));

  hint.textContent = rows.length
    ? `${rows.length} incident(s) found.`
    : "No incidents found for this subcontractor.";

  if (!rows.length){
    list.innerHTML = `<div class="small">No incidents match.</div>`;
    return;
  }

  // Cap to keep it executive-clean
  const cap = 25;
  const shown = rows.slice(0, cap);

  list.innerHTML = shown.map(r => `
    <div class="inc-row">
      <div>
        <strong>${safeText(r.Date) || "—"}</strong>
        <div class="meta">${safeText(r.IncidentID) || "—"}</div>
      </div>
      <div>
        <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
        <div class="meta">${safeText(r.Project) || ""}</div>
      </div>
      <div style="text-align:right;">
        ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
      </div>
    </div>
  `).join("");

  if (rows.length > cap){
    list.innerHTML += `<div class="small" style="padding-top:10px;">Showing first ${cap}. Refine using the Incidents search below if needed.</div>`;
  }

}


function pillForSeverity(sev){
  const s = (sev || "").toLowerCase();
  if (s === "high") return `<span class="pill high">High</span>`;
  if (s === "moderate") return `<span class="pill mod">Moderate</span>`;
  if (s === "low") return `<span class="pill low">Low</span>`;
  return "";
}

function normalizeIncidentRows(rows){
  return rows.map(r => ({
    Date: r.Date || r.date || "",
    IncidentID: r.IncidentID || r.IncidentId || r.ID || r.Id || "",
    Subcontractor: r.Subcontractor || r.subcontractor || r.Sub || "",
    Project: r.Project || r.project || "",
    Severity: r.Severity || r.severity || "",
    ReportLink: r.ReportLink || r.reportlink || r.Link || ""
  })).filter(x => x.IncidentID && String(x.IncidentID).trim().toLowerCase() !== "incidentid");
}

function renderIncidentDetail(item){
  const box = document.getElementById("incDetail");
  if(!item){
    box.innerHTML = `
      <div class="title">Select an incident</div>
      <div class="hint">Details will appear here.</div>
      <div class="small">No selection.</div>
    `;
    return;
  }

  box.innerHTML = `
    <div class="title">${safeText(item.IncidentID) || "—"}</div>
    <div class="hint">${safeText(item.Date) || ""} • ${safeText(item.Severity) || "—"} • ${safeText(item.Subcontractor) || "—"}</div>
    <div class="kv">
      <div class="k">Project</div><div class="v">${safeText(item.Project) || "—"}</div>
      <div class="k">Subcontractor</div><div class="v">${safeText(item.Subcontractor) || "—"}</div>
      <div class="k">Severity</div><div class="v">${safeText(item.Severity) || "—"}</div>
      <div class="k">Date</div><div class="v">${safeText(item.Date) || "—"}</div>
    </div>
    <div style="margin-top:12px;">
      ${item.ReportLink
        ? `<a class="link" href="${item.ReportLink}" target="_blank" rel="noopener">View report</a>`
        : `<span class="small">No report link</span>`}
    </div>
  `;
}

function renderIncidentsLookup(rows){
  INC_ALL = normalizeIncidentRows(rows);

  const dl = document.getElementById("incList");
  dl.innerHTML = [...INC_ALL]
    .sort((a,b)=> String(a.IncidentID).localeCompare(String(b.IncidentID)))
    .map(r => `<option value="${safeText(r.IncidentID)}"></option>`)
    .join("");

  const pick = document.getElementById("incPick");
  if(!pick.dataset.wired){
    pick.dataset.wired = "1";
    const apply = () => {
      const v = (pick.value || "").trim().toLowerCase();
      const found = INC_ALL.find(x => String(x.IncidentID || "").trim().toLowerCase() === v);
      renderIncidentDetail(found || null);
    };
    pick.addEventListener("change", apply);
    pick.addEventListener("blur", apply);
    pick.addEventListener("keydown", (e)=>{ if(e.key==="Enter") apply(); });
  }
}

function renderIncidentsTable(allIncidents){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const sev = document.getElementById("sev").value;

  let rows = normalizeIncidentRows(allIncidents);

  if (sev) rows = rows.filter(r => (r.Severity || "") === sev);

  if (q){
    rows = rows.filter(r => (
      String(r.IncidentID || "").toLowerCase().includes(q) ||
      String(r.Subcontractor || "").toLowerCase().includes(q) ||
      String(r.Project || "").toLowerCase().includes(q)
    ));
  }

  rows.sort((a,b)=>{
    const da = Date.parse(a.Date) || 0;
    const db = Date.parse(b.Date) || 0;
    return db - da;
  });

  const cap = (q || sev) ? 10 : 5;
  const shown = rows.slice(0, cap);

  document.getElementById("incHint").textContent =
    (q || sev)
      ? `Showing top ${Math.min(cap, rows.length)} matches (capped).`
      : "Showing latest 5 incidents.";

  const list = document.getElementById("incidentList");
  if (!shown.length){
    list.innerHTML = `<div class="small" style="padding:12px 0;">No incidents match your filters.</div>`;
    return;
  }

  list.innerHTML = shown.map(r => `
    <div class="inc-row">
      <div>
        <strong>${safeText(r.Date) || "—"}</strong>
        <div class="meta">${safeText(r.IncidentID) || "—"}</div>
      </div>
      <div>
        <strong>${safeText(r.Subcontractor) || "—"} ${pillForSeverity(r.Severity)}</strong>
        <div class="meta">${safeText(r.Project) || ""}</div>
      </div>
      <div style="text-align:right;">
        ${r.ReportLink ? `<a class="link" href="${r.ReportLink}" target="_blank" rel="noopener">View report</a>` : `<span class="small">—</span>`}
      </div>
    </div>
  `).join("");
}

/*** init ***/
(async function init(){
  try {
    setStatus("Loading data…");
    const [kpis, subs, inc] = await Promise.all([
      fetchTable(KPI_CSV),
      fetchTable(SUBS_CSV),
      fetchTable(INCIDENTS_CSV)
    ]);

    renderKPIs(kpis);
    renderSubs(subs);
    // Sub incident panel close
    const subClose = document.getElementById("subIncClose");
    subClose.addEventListener("click", ()=>{
      document.getElementById("subIncPanel").style.display = "none";
      setActiveSubCard("");
    });


    // Incidents: list + lookup/detail
    renderIncidentsTable(inc);
    renderIncidentsLookup(inc);

    // Optional: auto-select most recent incident into detail panel
    // (keeps panel from looking empty on load)
    const latest = normalizeIncidentRows(inc).sort((a,b)=>{
      const da = Date.parse(a.Date) || 0;
      const db = Date.parse(b.Date) || 0;
      return db - da;
    })[0];
    if (latest) renderIncidentDetail(latest);

    document.getElementById("q").addEventListener("input", ()=>renderIncidentsTable(inc));
    document.getElementById("sev").addEventListener("change", ()=>renderIncidentsTable(inc));
    document.getElementById("clear").addEventListener("click", (e)=>{
      e.preventDefault();
      document.getElementById("q").value = "";
      document.getElementById("sev").value = "";
      renderIncidentsTable(inc);
    });

    setStatus("");
  } catch (err){
    console.error(err);
    setStatus("Data fetch failed. Check CSV publish links, then refresh.", true);
    document.getElementById("subHint").textContent = "Could not load subcontractor data. Verify your published SUBS CSV.";
    document.getElementById("incHint").textContent = "Could not load incidents. Verify your published INCIDENTS CSV.";
  }
})();
</script>
</body>
</html>

